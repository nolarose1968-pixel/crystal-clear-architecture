name: ğŸ”’ Security & Dependency Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: false
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'dependencies'
          - 'code'
          - 'secrets'

env:
  BUN_VERSION: '1.2.21'

jobs:
  # Dependency vulnerability scanning
  dependency-scan:
    name: ğŸ” Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ” Bun Audit
        run: |
          echo "## ğŸ” Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
          if bun audit --json > audit-results.json 2>/dev/null; then
            echo "âœ… No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            cat audit-results.json
          else
            echo "âš ï¸ Vulnerabilities detected - review required" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ğŸ“Š Upload Audit Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit-results
          path: audit-results.json
          retention-days: 30

  # Secret scanning
  secret-scan:
    name: ğŸ•µï¸ Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive scanning

      - name: ğŸ” Scan for Secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ğŸ” Check Environment Files
        run: |
          echo "## ğŸ” Environment File Security Check" >> $GITHUB_STEP_SUMMARY

          # Check for .env files that shouldn't be committed
          if find . -name ".env*" -not -path "./node_modules/*" -not -name ".env.example" -not -name ".env.template"; then
            echo "âš ï¸ Found .env files - ensure no secrets are committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No suspicious .env files found" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for common secret patterns in committed files
          if grep -r -i "password\|secret\|key\|token" --include="*.ts" --include="*.js" --include="*.json" . | grep -v node_modules | head -5; then
            echo "âš ï¸ Found potential secrets in code - review required" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No obvious secrets detected in code" >> $GITHUB_STEP_SUMMARY
          fi

  # Code security analysis
  code-security:
    name: ğŸ“ Code Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ›¡ï¸ Run Security Scanner
        run: bun run scripts/security-scanner-demo.ts
        continue-on-error: true

      - name: ğŸ” Environment Security Check
        run: |
          if [ -f "scripts/secure-env-manager.ts" ]; then
            bun run scripts/secure-env-manager.ts audit
          fi
        continue-on-error: true

      - name: ğŸ“Š Generate Security Report
        run: |
          echo "## ğŸ›¡ï¸ Code Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security scanner completed" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ” Environment audit completed" >> $GITHUB_STEP_SUMMARY

  # SAST - Static Application Security Testing
  static-analysis:
    name: ğŸ”¬ Static Application Security Testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ” ESLint Security Rules
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ” Security-focused Linting
        run: |
          # Run ESLint with security-focused rules
          if bun run lint 2>&1 | tee lint-security.log; then
            echo "âœ… No security linting issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security linting issues detected" >> $GITHUB_STEP_SUMMARY
            cat lint-security.log >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”’ TypeScript Security Check
        run: |
          # Check for unsafe TypeScript patterns
          echo "## ğŸ”’ TypeScript Security Analysis" >> $GITHUB_STEP_SUMMARY

          # Check for 'any' types that could bypass security
          ANY_COUNT=$(grep -r ": any" src/ --include="*.ts" | wc -l || echo "0")
          echo "- TypeScript 'any' types found: ${ANY_COUNT}" >> $GITHUB_STEP_SUMMARY

          # Check for eval usage
          EVAL_COUNT=$(grep -r "eval(" src/ --include="*.ts" --include="*.js" | wc -l || echo "0")
          echo "- Potential eval() usage: ${EVAL_COUNT}" >> $GITHUB_STEP_SUMMARY

          if [ "$EVAL_COUNT" -gt "0" ]; then
            echo "âš ï¸ eval() usage detected - security review required" >> $GITHUB_STEP_SUMMARY
          fi

  # Workspace security validation
  workspace-security:
    name: ğŸ¢ Workspace Security Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ¢ Validate Workspace Security
        run: |
          echo "## ğŸ¢ Workspace Security Validation" >> $GITHUB_STEP_SUMMARY

          # Check each workspace for security configurations
          for workspace in workspaces/@fire22-*; do
            if [ -d "$workspace" ]; then
              WORKSPACE_NAME=$(basename "$workspace")
              echo "### ${WORKSPACE_NAME}" >> $GITHUB_STEP_SUMMARY
              
              # Check for security-related files
              if [ -f "$workspace/bunfig.toml" ]; then
                echo "- âœ… Bun configuration present" >> $GITHUB_STEP_SUMMARY
              fi
              
              if [ -f "$workspace/wrangler.toml" ] || [ -f "$workspace/wrangler.linked.toml" ]; then
                echo "- âœ… Cloudflare Workers configuration present" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Check package.json for security-related dependencies
              if [ -f "$workspace/package.json" ]; then
                if grep -q "security\|auth\|crypto" "$workspace/package.json"; then
                  echo "- ğŸ”’ Security dependencies detected" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            fi
          done

      - name: ğŸ”’ Security Registry Check
        run: |
          if [ -d "workspaces/@fire22-security-registry" ]; then
            echo "## ğŸ”’ Security Registry Status" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Security registry workspace exists" >> $GITHUB_STEP_SUMMARY
            
            # Run security registry validation if available
            if [ -f "workspaces/@fire22-security-registry/src/cli.ts" ]; then
              cd workspaces/@fire22-security-registry
              if bun run src/cli.ts validate 2>/dev/null; then
                echo "âœ… Security registry validation passed" >> $GITHUB_STEP_SUMMARY
              else
                echo "âš ï¸ Security registry validation issues detected" >> $GITHUB_STEP_SUMMARY
              fi
              cd ../..
            fi
          fi

  # Container security (if using Docker)
  container-security:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    if: hashFiles('Dockerfile') != ''
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ³ Build Docker Image
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t fire22-dashboard:security-scan .
          else
            echo "No Dockerfile found, skipping container security scan"
            exit 0
          fi

      - name: ğŸ” Container Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'fire22-dashboard:security-scan'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Container Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # License compliance
  license-check:
    name: ğŸ“œ License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ“œ Check License Compliance
        run: |
          echo "## ğŸ“œ License Compliance Check" >> $GITHUB_STEP_SUMMARY

          # Check for package licenses
          bun pm ls --all 2>/dev/null | grep -E "license|License" | head -10 || echo "License information not available"

          echo "âœ… License compliance check completed" >> $GITHUB_STEP_SUMMARY

  # Security summary
  security-summary:
    name: ğŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        dependency-scan,
        secret-scan,
        code-security,
        static-analysis,
        workspace-security,
        license-check,
      ]
    if: always()
    steps:
      - name: ğŸ“Š Generate Security Summary
        run: |
          echo "## ğŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ•µï¸ Secret Detection | ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ Code Security | ${{ needs.code-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¬ Static Analysis | ${{ needs.static-analysis.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¢ Workspace Security | ${{ needs.workspace-security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“œ License Check | ${{ needs.license-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          # Determine overall security status
          if [[ "${{ needs.dependency-scan.result }}" == "success" && \
                "${{ needs.secret-scan.result }}" == "success" && \
                "${{ needs.code-security.result }}" == "success" && \
                "${{ needs.static-analysis.result }}" == "success" && \
                "${{ needs.workspace-security.result }}" == "success" && \
                "${{ needs.license-check.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ **Overall Security Status: âœ… PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All security checks completed successfully! ğŸ”’" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Overall Security Status: âŒ ATTENTION REQUIRED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more security checks require attention. Please review the failed checks above." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”’ Security Gate
        run: |
          if [[ "${{ needs.dependency-scan.result }}" == "success" && \
                "${{ needs.secret-scan.result }}" == "success" && \
                ("${{ needs.code-security.result }}" == "success" || "${{ needs.code-security.result }}" == "skipped") && \
                "${{ needs.static-analysis.result }}" == "success" && \
                "${{ needs.workspace-security.result }}" == "success" && \
                "${{ needs.license-check.result }}" == "success" ]]; then
            echo "ğŸ‰ All critical security checks passed!"
            exit 0
          else
            echo "âŒ Critical security checks failed - blocking deployment"
            exit 1
          fi
