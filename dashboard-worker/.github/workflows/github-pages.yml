name: ğŸš€ GitHub Pages & Wiki Mirror Deployment

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'wiki/**'
      - 'src/departments/**'
      - 'scripts/build-pages.ts'
      - '.github/workflows/github-pages.yml'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deployment target'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - github-pages
          - cloudflare-pages
          - wiki-mirror
  schedule:
    # Run daily at 2 AM UTC for wiki sync
    - cron: '0 2 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

env:
  BUN_VERSION: '1.2.21'

jobs:
  # ğŸ—ï¸ Build GitHub Pages
  build-pages:
    name: ğŸ—ï¸ Build GitHub Pages
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ—ï¸ Build GitHub Pages
        run: |
          echo "ğŸš€ Building GitHub Pages with Bun..."
          bun run build:pages --env production --minify

      - name: ğŸ“Š Generate department pages
        run: |
          echo "ğŸ“Š Generating department documentation pages..."
          bun run scripts/generate-department-pages.ts

      - name: ğŸ“ Generate wiki mirror
        run: |
          echo "ğŸ“ Mirroring wiki content..."
          bun run scripts/mirror-wiki.ts

      - name: ğŸ¨ Build assets
        run: |
          echo "ğŸ¨ Building CSS and static assets..."
          bun run build:assets

      - name: ğŸ“¦ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist/pages

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pages-build
          path: |
            dist/pages/
            dist/wiki/
            reports/build-report.json

  # ğŸš€ Deploy to GitHub Pages
  deploy-github-pages:
    name: ğŸš€ Deploy to GitHub Pages
    if: github.event_name == 'push' || github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'github-pages'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-pages
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Verify deployment
        run: |
          echo "âœ… GitHub Pages deployed successfully!"
          echo "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}"

  # â˜ï¸ Deploy to Cloudflare Pages
  deploy-cloudflare:
    name: â˜ï¸ Deploy to Cloudflare Pages
    if: github.event_name == 'push' || github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'cloudflare-pages'
    runs-on: ubuntu-latest
    needs: build-pages
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pages-build
          path: dist/

      - name: â˜ï¸ Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: fire22-dashboard
          directory: dist/pages
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          wranglerVersion: '3'

      - name: âœ… Verify Cloudflare deployment
        run: |
          echo "âœ… Cloudflare Pages deployed successfully!"
          echo "ğŸ”— URL: https://fire22-dashboard.pages.dev"
          echo "ğŸ”— Custom Domain: https://dashboard.fire22.ag"

  # ğŸ“š Sync Wiki Mirror
  sync-wiki:
    name: ğŸ“š Sync Wiki Mirror
    if: github.event_name == 'schedule' || github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'wiki-mirror'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Checkout wiki
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ“š Sync wiki content
        run: |
          echo "ğŸ“š Syncing wiki content..."
          bun run scripts/sync-wiki.ts --source wiki-repo --target wiki

      - name: ğŸ“ Generate wiki pages
        run: |
          echo "ğŸ“ Generating wiki static pages..."
          bun run scripts/build-wiki-pages.ts

      - name: ğŸ”„ Commit wiki changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add wiki/
          if git diff --staged --quiet; then
            echo "No wiki changes to commit"
          else
            git commit -m "chore: sync wiki mirror [skip ci]"
            git push
          fi

  # ğŸ” Validate All Deployments
  validate-deployments:
    name: ğŸ” Validate All Deployments
    runs-on: ubuntu-latest
    needs: [deploy-github-pages, deploy-cloudflare, sync-wiki]
    if: always()
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ” Validate GitHub Pages
        run: |
          echo "ğŸ” Validating GitHub Pages deployment..."
          bun run scripts/validate-deployment.ts --target github-pages

      - name: ğŸ” Validate Cloudflare Pages
        run: |
          echo "ğŸ” Validating Cloudflare Pages deployment..."
          bun run scripts/validate-deployment.ts --target cloudflare-pages

      - name: ğŸ” Validate Wiki Mirror
        run: |
          echo "ğŸ” Validating Wiki Mirror..."
          bun run scripts/validate-deployment.ts --target wiki-mirror

      - name: ğŸ“Š Generate deployment report
        run: |
          echo "ğŸ“Š Generating deployment report..."
          bun run scripts/generate-deployment-report.ts

      - name: ğŸ“¦ Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-validation
          path: reports/deployment-validation.json

      - name: ğŸ“¨ Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… All deployments validated successfully!"
          else
            echo "âš ï¸ Some deployments may have issues. Check the validation report."
          fi
