<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction History Dashboard - Financial Analytics</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.js"></script>

    <style>
      .transaction-history-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .dashboard-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 20px;
        border: none;
      }

      .card-header-custom {
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 15px;
        border: none;
      }

      .transaction-card {
        transition: transform 0.2s ease;
        cursor: pointer;
        border-left: 4px solid;
      }

      .transaction-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .transaction-deposit {
        border-left-color: #28a745;
      }
      .transaction-withdrawal {
        border-left-color: #dc3545;
      }
      .transaction-transfer {
        border-left-color: #17a2b8;
      }
      .transaction-bonus {
        border-left-color: #ffc107;
      }
      .transaction-fee {
        border-left-color: #6c757d;
      }

      .transaction-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
      }

      .amount-positive {
        color: #28a745;
        font-weight: bold;
      }

      .amount-negative {
        color: #dc3545;
        font-weight: bold;
      }

      .amount-neutral {
        color: #6c757d;
        font-weight: bold;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: bold;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }
      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-failed {
        background: #f8d7da;
        color: #721c24;
      }
      .status-processing {
        background: #d1ecf1;
        color: #0c5460;
      }

      .filter-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .analytics-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
      }

      .analytics-value {
        font-size: 2.5em;
        font-weight: bold;
        margin: 10px 0;
      }

      .analytics-label {
        color: #6c757d;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .chart-container {
        height: 400px;
        margin-bottom: 20px;
      }

      .transaction-details-modal .modal-dialog {
        max-width: 800px;
      }

      .search-input {
        position: relative;
      }

      .search-input i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
      }

      .export-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        z-index: 10;
      }

      .trend-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9em;
      }

      .trend-up {
        color: #28a745;
      }

      .trend-down {
        color: #dc3545;
      }

      .pagination-custom {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
      }

      .page-btn {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .page-btn:hover:not(:disabled) {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .page-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .transaction-timeline {
        position: relative;
        padding-left: 30px;
      }

      .timeline-item {
        position: relative;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border-left: 3px solid;
      }

      .timeline-item::before {
        content: '';
        position: absolute;
        left: -38px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        border: 2px solid #dee2e6;
      }

      .timeline-item.deposit {
        border-left-color: #28a745;
      }
      .timeline-item.withdrawal {
        border-left-color: #dc3545;
      }
      .timeline-item.transfer {
        border-left-color: #17a2b8;
      }
      .timeline-item.bonus {
        border-left-color: #ffc107;
      }

      .timeline-item.deposit::before {
        border-color: #28a745;
        background: #28a745;
      }
      .timeline-item.withdrawal::before {
        border-color: #dc3545;
        background: #dc3545;
      }
      .timeline-item.transfer::before {
        border-color: #17a2b8;
        background: #17a2b8;
      }
      .timeline-item.bonus::before {
        border-color: #ffc107;
        background: #ffc107;
      }

      @media (max-width: 768px) {
        .analytics-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .export-buttons {
          justify-content: center;
        }

        .filter-section .row > div {
          margin-bottom: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="transaction-history-dashboard">
      <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h2 class="mb-0">
                  <i class="fas fa-history mr-2"></i>
                  Transaction History Dashboard
                  <span class="badge badge-light ml-2" id="system-status">Active</span>
                </h2>
                <p class="mb-0 mt-2 opacity-75">Comprehensive financial transaction analytics and monitoring</p>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <div class="form-group search-input">
                      <label for="transaction-search">Search Transactions</label>
                      <input
                        type="text"
                        class="form-control"
                        id="transaction-search"
                        placeholder="Transaction ID, amount, or description"
                      />
                      <i class="fas fa-search"></i>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label for="transaction-type-filter">Type</label>
                      <select class="form-control" id="transaction-type-filter">
                        <option value="all">All Types</option>
                        <option value="deposit">Deposits</option>
                        <option value="withdrawal">Withdrawals</option>
                        <option value="transfer">Transfers</option>
                        <option value="bonus">Bonuses</option>
                        <option value="fee">Fees</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label for="status-filter">Status</label>
                      <select class="form-control" id="status-filter">
                        <option value="all">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Failed</option>
                        <option value="processing">Processing</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-group">
                      <label>Date Range</label>
                      <input type="text" class="form-control" id="date-range-picker" placeholder="Select date range" />
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label>&nbsp;</label>
                      <div class="export-buttons">
                        <button class="btn btn-outline-primary btn-sm" id="refresh-data">
                          <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="export-csv">
                          <i class="fas fa-file-csv"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="export-pdf">
                          <i class="fas fa-file-pdf"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Analytics Overview -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="analytics-grid" id="analytics-grid">
              <!-- Analytics cards will be populated by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
          <div class="col-lg-8">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-chart-line mr-2"></i>
                  Transaction Trends
                </h4>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="transactionChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-chart-pie mr-2"></i>
                  Transaction Types
                </h4>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="transactionTypeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Transaction List -->
        <div class="row">
          <div class="col-12">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-list mr-2"></i>
                  Recent Transactions
                  <span class="badge badge-light ml-2" id="transaction-count">0</span>
                </h4>
              </div>
              <div class="card-body position-relative">
                <div id="loading-overlay" class="loading-overlay" style="display: none">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <div class="mt-2">Loading transactions...</div>
                  </div>
                </div>

                <div id="transaction-container">
                  <!-- Transaction cards will be populated here -->
                </div>

                <!-- Pagination -->
                <div class="pagination-custom" id="pagination-container" style="display: none">
                  <button class="page-btn" id="prev-page" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Previous
                  </button>
                  <span id="page-info">Page 1 of 1</span>
                  <button class="page-btn" id="next-page" disabled>
                    Next
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Transaction Details Modal -->
    <div class="modal fade transaction-details-modal" id="transactionDetailsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-receipt mr-2"></i>
              Transaction Details
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body" id="transaction-details-content">
            <!-- Transaction details will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="view-customer">
              <i class="fas fa-user mr-1"></i>
              View Customer
            </button>
            <button type="button" class="btn btn-warning" id="refund-transaction" style="display: none">
              <i class="fas fa-undo mr-1"></i>
              Process Refund
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Transaction History JavaScript -->
    <script>
      class TransactionHistoryDashboard {
        constructor() {
          this.transactions = [];
          this.filteredTransactions = [];
          this.analytics = {};
          this.charts = {};
          this.currentPage = 1;
          this.pageSize = 20;
          this.totalPages = 1;
          this.filters = {
            search: '',
            type: 'all',
            status: 'all',
            dateRange: null,
          };

          this.initializeEventHandlers();
          this.initializeCharts();
          this.initializeDateRangePicker();
          this.loadInitialData();
          this.startRealTimeUpdates();
        }

        initializeEventHandlers() {
          // Search functionality
          $('#transaction-search').on('input', e => {
            this.filters.search = e.target.value;
            this.applyFilters();
          });

          // Filter controls
          $('#transaction-type-filter, #status-filter').on('change', () => {
            this.filters.type = $('#transaction-type-filter').val();
            this.filters.status = $('#status-filter').val();
            this.applyFilters();
          });

          // Refresh button
          $('#refresh-data').on('click', () => {
            this.loadTransactionData();
          });

          // Export buttons
          $('#export-csv').on('click', () => {
            this.exportTransactions('csv');
          });

          $('#export-pdf').on('click', () => {
            this.exportTransactions('pdf');
          });

          // Pagination
          $('#prev-page').on('click', () => {
            if (this.currentPage > 1) {
              this.currentPage--;
              this.renderTransactions();
            }
          });

          $('#next-page').on('click', () => {
            if (this.currentPage < this.totalPages) {
              this.currentPage++;
              this.renderTransactions();
            }
          });

          // Transaction card clicks
          $(document).on('click', '.transaction-card', e => {
            const transactionId = $(e.currentTarget).data('transaction-id');
            this.showTransactionDetails(transactionId);
          });
        }

        initializeCharts() {
          // Transaction trends chart
          const trendCtx = document.getElementById('transactionChart').getContext('2d');
          this.charts.trends = new Chart(trendCtx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'Transaction Volume',
                  data: [],
                  borderColor: '#007bff',
                  backgroundColor: 'rgba(0, 123, 255, 0.1)',
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return '$' + value.toFixed(0);
                    },
                  },
                },
              },
            },
          });

          // Transaction types chart
          const typeCtx = document.getElementById('transactionTypeChart').getContext('2d');
          this.charts.types = new Chart(typeCtx, {
            type: 'doughnut',
            data: {
              labels: [],
              datasets: [
                {
                  data: [],
                  backgroundColor: [
                    '#28a745', // deposit
                    '#dc3545', // withdrawal
                    '#17a2b8', // transfer
                    '#ffc107', // bonus
                    '#6c757d', // fee
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                },
              },
            },
          });
        }

        initializeDateRangePicker() {
          $('#date-range-picker').daterangepicker(
            {
              autoApply: true,
              locale: {
                format: 'MM/DD/YYYY',
              },
              ranges: {
                Today: [moment(), moment()],
                Yesterday: [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [
                  moment().subtract(1, 'month').startOf('month'),
                  moment().subtract(1, 'month').endOf('month'),
                ],
              },
            },
            (start, end) => {
              this.filters.dateRange = {
                start: start.format('YYYY-MM-DD'),
                end: end.format('YYYY-MM-DD'),
              };
              this.applyFilters();
            }
          );
        }

        async loadInitialData() {
          this.showLoadingState();
          await Promise.all([this.loadTransactionData(), this.loadAnalytics()]);
          this.hideLoadingState();
        }

        async loadTransactionData() {
          try {
            // Try to fetch real data first, fall back to simulated data
            const response = await this.fetchRealTransactionData();
            this.transactions = response.data || response;
            this.applyFilters();
            this.updateCharts();
          } catch (error) {
            console.error('Failed to load transaction data:', error);
            // Fall back to simulated data for demo purposes
            try {
              const fallbackResponse = await this.simulateTransactionDataFetch();
              this.transactions = fallbackResponse.data;
              this.applyFilters();
              this.updateCharts();
              this.showError('Using demo data - API integration needed');
            } catch (fallbackError) {
              this.showError('Failed to load transaction data');
            }
          }
        }

        async fetchRealTransactionData() {
          // Use the unified dashboard integration for real data
          try {
            const response = await fetch('/api/dashboard/transaction-history', {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${this.getAuthToken()}`,
              },
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.success) {
              return {
                data: data.data.transactions.map(t => ({
                  id: t.id,
                  customerId: t.customerId,
                  customerName: t.customerName,
                  type: t.type,
                  status: t.status,
                  amount: t.amount,
                  toWinAmount: t.toWinAmount || t.amount,
                  settlementAmount: t.settlementAmount || 0,
                  description: t.description || `${t.type.charAt(0).toUpperCase() + t.type.slice(1)} Transaction`,
                  timestamp: t.timestamp,
                  paymentMethod: t.paymentMethod || 'unknown',
                  reference: t.reference || '',
                  location: t.location || 'Online',
                  fee: t.fee || 0,
                })),
              };
            } else {
              throw new Error(data.error || 'Failed to fetch transaction data');
            }
          } catch (error) {
            console.error('Error fetching real transaction data:', error);
            // Fall back to simulated data for demo purposes
            return this.simulateTransactionDataFetch();
          }
        }

        async simulateTransactionDataFetch() {
          // Mock comprehensive transaction data
          return new Promise(resolve => {
            setTimeout(() => {
              const transactions = [];
              const types = ['deposit', 'withdrawal', 'transfer', 'bonus', 'fee'];
              const statuses = ['completed', 'pending', 'failed', 'processing'];
              const descriptions = [
                'Cash Deposit',
                'ATM Withdrawal',
                'Wire Transfer',
                'Bonus Reward',
                'Monthly Fee',
                'Online Purchase',
                'Check Deposit',
                'Mobile Payment',
              ];

              // Generate sample transactions
              for (let i = 0; i < 50; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const amount = Math.random() * 500 + 50; // $50 to $550
                const daysAgo = Math.floor(Math.random() * 30); // Last 30 days

                transactions.push({
                  id: `TXN${String(100000 + i).padStart(6, '0')}`,
                  customerId: `CUST${String(Math.floor(Math.random() * 1000)).padStart(4, '0')}`,
                  customerName: `Customer ${Math.floor(Math.random() * 1000)}`,
                  type: type,
                  status: status,
                  amount: parseFloat(amount.toFixed(2)),
                  toWinAmount: parseFloat((amount * 1.5).toFixed(2)),
                  settlementAmount: type === 'win' ? parseFloat((amount * 1.5).toFixed(2)) : 0,
                  description: descriptions[Math.floor(Math.random() * descriptions.length)],
                  timestamp: new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000).toISOString(),
                  paymentMethod: ['cash', 'card', 'bank_transfer', 'crypto'][Math.floor(Math.random() * 4)],
                  reference: `REF${String(Math.floor(Math.random() * 1000000)).padStart(7, '0')}`,
                  location: ['Branch A', 'Online', 'ATM', 'Mobile App'][Math.floor(Math.random() * 4)],
                  fee: type === 'withdrawal' ? parseFloat((amount * 0.02).toFixed(2)) : 0,
                });
              }

              resolve({
                data: transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)),
              });
            }, 1000);
          });
        }

        applyFilters() {
          this.filteredTransactions = this.transactions.filter(transaction => {
            // Search filter
            if (this.filters.search) {
              const searchTerm = this.filters.search.toLowerCase();
              const matches =
                transaction.id.toLowerCase().includes(searchTerm) ||
                transaction.customerId.toLowerCase().includes(searchTerm) ||
                transaction.customerName.toLowerCase().includes(searchTerm) ||
                transaction.description.toLowerCase().includes(searchTerm);
              if (!matches) return false;
            }

            // Type filter
            if (this.filters.type !== 'all' && transaction.type !== this.filters.type) {
              return false;
            }

            // Status filter
            if (this.filters.status !== 'all' && transaction.status !== this.filters.status) {
              return false;
            }

            // Date range filter
            if (this.filters.dateRange) {
              const transactionDate = new Date(transaction.timestamp).toISOString().split('T')[0];
              if (transactionDate < this.filters.dateRange.start || transactionDate > this.filters.dateRange.end) {
                return false;
              }
            }

            return true;
          });

          this.totalPages = Math.ceil(this.filteredTransactions.length / this.pageSize);
          this.currentPage = 1;
          this.renderTransactions();
          this.updateAnalytics();
        }

        renderTransactions() {
          const container = $('#transaction-container');
          const startIndex = (this.currentPage - 1) * this.pageSize;
          const endIndex = startIndex + this.pageSize;
          const pageTransactions = this.filteredTransactions.slice(startIndex, endIndex);

          container.empty();

          if (pageTransactions.length === 0) {
            container.html(`
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No transactions found</h5>
                            <p class="text-muted">Try adjusting your search criteria</p>
                        </div>
                    `);
            $('#pagination-container').hide();
            return;
          }

          pageTransactions.forEach(transaction => {
            const amountClass = this.getAmountClass(transaction.type);
            const amountPrefix = this.getAmountPrefix(transaction.type);
            const statusClass = `status-${transaction.status}`;
            const iconClass = this.getTransactionIconClass(transaction.type);

            const transactionCard = `
                        <div class="transaction-card mb-3 p-3 border rounded transaction-${transaction.type}"
                             data-transaction-id="${transaction.id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-start">
                                    <div class="transaction-icon ${iconClass} mr-3">
                                        <i class="${this.getTransactionIcon(transaction.type)}"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <h6 class="mb-0 mr-2">${transaction.description}</h6>
                                            <span class="status-badge ${statusClass}">${transaction.status}</span>
                                        </div>
                                        <p class="mb-1 text-muted small">
                                            ${transaction.id} • ${transaction.customerName} (${transaction.customerId})
                                        </p>
                                        <p class="mb-0 text-muted small">
                                            <i class="fas fa-calendar mr-1"></i>
                                            ${this.formatDateTime(new Date(transaction.timestamp))}
                                            <i class="fas fa-map-marker-alt ml-3 mr-1"></i>
                                            ${transaction.location}
                                            <i class="fas fa-credit-card ml-3 mr-1"></i>
                                            ${transaction.paymentMethod}
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="amount-value ${amountClass} h5 mb-1">
                                        ${amountPrefix}$${transaction.amount.toFixed(2)}
                                    </div>
                                    ${transaction.fee > 0 ? `<small class="text-muted">Fee: $${transaction.fee.toFixed(2)}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    `;

            container.append(transactionCard);
          });

          // Update pagination
          this.updatePagination();
          $('#pagination-container').show();
          $('#transaction-count').text(this.filteredTransactions.length);
        }

        updatePagination() {
          $('#page-info').text(`Page ${this.currentPage} of ${this.totalPages}`);
          $('#prev-page').prop('disabled', this.currentPage === 1);
          $('#next-page').prop('disabled', this.currentPage === this.totalPages);
        }

        async loadAnalytics() {
          // Calculate analytics from transaction data
          this.analytics = {
            totalTransactions: this.transactions.length,
            totalVolume: this.transactions.reduce((sum, t) => sum + t.amount, 0),
            averageTransaction:
              this.transactions.length > 0
                ? this.transactions.reduce((sum, t) => sum + t.amount, 0) / this.transactions.length
                : 0,
            pendingTransactions: this.transactions.filter(t => t.status === 'pending').length,
            failedTransactions: this.transactions.filter(t => t.status === 'failed').length,
            deposits: this.transactions.filter(t => t.type === 'deposit').reduce((sum, t) => sum + t.amount, 0),
            withdrawals: this.transactions.filter(t => t.type === 'withdrawal').reduce((sum, t) => sum + t.amount, 0),
          };

          this.renderAnalytics();
        }

        updateAnalytics() {
          // Update analytics based on filtered data
          const filtered = this.filteredTransactions;
          this.analytics.filteredTotal = filtered.length;
          this.analytics.filteredVolume = filtered.reduce((sum, t) => sum + t.amount, 0);
          this.renderAnalytics();
        }

        renderAnalytics() {
          const analytics = this.analytics;
          const grid = $('#analytics-grid');

          grid.html(`
                    <div class="analytics-card">
                        <div class="analytics-value">${analytics.totalTransactions.toLocaleString()}</div>
                        <div class="analytics-label">Total Transactions</div>
                        ${
                          analytics.filteredTotal !== undefined &&
                          analytics.filteredTotal !== analytics.totalTransactions
                            ? `<small class="text-muted">Filtered: ${analytics.filteredTotal.toLocaleString()}</small>`
                            : ''
                        }
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value text-success">$${analytics.totalVolume.toLocaleString()}</div>
                        <div class="analytics-label">Total Volume</div>
                        ${
                          analytics.filteredVolume !== undefined && analytics.filteredVolume !== analytics.totalVolume
                            ? `<small class="text-muted">Filtered: $${analytics.filteredVolume.toLocaleString()}</small>`
                            : ''
                        }
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value text-info">$${analytics.averageTransaction.toFixed(2)}</div>
                        <div class="analytics-label">Average Transaction</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value text-warning">${analytics.pendingTransactions}</div>
                        <div class="analytics-label">Pending</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value text-success">$${analytics.deposits.toLocaleString()}</div>
                        <div class="analytics-label">Total Deposits</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value text-danger">$${analytics.withdrawals.toLocaleString()}</div>
                        <div class="analytics-label">Total Withdrawals</div>
                    </div>
                `);
        }

        updateCharts() {
          this.updateTrendsChart();
          this.updateTypesChart();
        }

        updateTrendsChart() {
          // Group transactions by date for the last 30 days
          const last30Days = {};
          const now = new Date();

          for (let i = 29; i >= 0; i--) {
            const date = new Date(now);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            last30Days[dateStr] = 0;
          }

          // Count transactions per day
          this.transactions.forEach(transaction => {
            const dateStr = transaction.timestamp.split('T')[0];
            if (last30Days.hasOwnProperty(dateStr)) {
              last30Days[dateStr] += transaction.amount;
            }
          });

          const labels = Object.keys(last30Days);
          const data = Object.values(last30Days);

          this.charts.trends.data.labels = labels.map(date =>
            new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
          );
          this.charts.trends.data.datasets[0].data = data;
          this.charts.trends.update();
        }

        updateTypesChart() {
          // Count transactions by type
          const typeCounts = {};
          this.transactions.forEach(transaction => {
            typeCounts[transaction.type] = (typeCounts[transaction.type] || 0) + 1;
          });

          const labels = Object.keys(typeCounts).map(type => type.charAt(0).toUpperCase() + type.slice(1));
          const data = Object.values(typeCounts);

          this.charts.types.data.labels = labels;
          this.charts.types.data.datasets[0].data = data;
          this.charts.types.update();
        }

        showTransactionDetails(transactionId) {
          const transaction = this.transactions.find(t => t.id === transactionId);
          if (!transaction) return;

          const modalContent = `
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Transaction Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Transaction ID:</strong></td><td>${transaction.id}</td></tr>
                                <tr><td><strong>Type:</strong></td><td>${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="status-badge status-${transaction.status}">${transaction.status}</span></td></tr>
                                <tr><td><strong>Amount:</strong></td><td class="${this.getAmountClass(transaction.type)}">$${transaction.amount.toFixed(2)}</td></tr>
                                <tr><td><strong>Description:</strong></td><td>${transaction.description}</td></tr>
                                <tr><td><strong>Date/Time:</strong></td><td>${this.formatDateTime(new Date(transaction.timestamp))}</td></tr>
                                <tr><td><strong>Payment Method:</strong></td><td>${transaction.paymentMethod}</td></tr>
                                <tr><td><strong>Location:</strong></td><td>${transaction.location}</td></tr>
                                ${transaction.fee > 0 ? `<tr><td><strong>Fee:</strong></td><td>$${transaction.fee.toFixed(2)}</td></tr>` : ''}
                            </table>
                        </div>
                        <div class="col-md-4">
                            <h6>Customer Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Customer ID:</strong></td><td>${transaction.customerId}</td></tr>
                                <tr><td><strong>Name:</strong></td><td>${transaction.customerName}</td></tr>
                                <tr><td><strong>Reference:</strong></td><td>${transaction.reference}</td></tr>
                            </table>

                            <h6 class="mt-3">Quick Actions</h6>
                            <div class="btn-group-vertical btn-group-sm w-100">
                                <button class="btn btn-outline-primary" onclick="viewCustomer('${transaction.customerId}')">
                                    <i class="fas fa-user mr-1"></i> View Customer
                                </button>
                                <button class="btn btn-outline-info" onclick="viewSimilarTransactions('${transaction.type}')">
                                    <i class="fas fa-list mr-1"></i> Similar Transactions
                                </button>
                                ${
                                  transaction.status === 'completed'
                                    ? `
                                    <button class="btn btn-outline-warning" onclick="processRefund('${transaction.id}')">
                                        <i class="fas fa-undo mr-1"></i> Process Refund
                                    </button>
                                `
                                    : ''
                                }
                            </div>
                        </div>
                    </div>
                `;

          $('#transaction-details-content').html(modalContent);
          $('#transactionDetailsModal').modal('show');
        }

        exportTransactions(format) {
          const data = this.filteredTransactions.map(t => ({
            'Transaction ID': t.id,
            'Customer ID': t.customerId,
            'Customer Name': t.customerName,
            Type: t.type,
            Status: t.status,
            Amount: t.amount,
            Description: t.description,
            Date: this.formatDateTime(new Date(t.timestamp)),
            'Payment Method': t.paymentMethod,
            Location: t.location,
            Fee: t.fee || 0,
            Reference: t.reference,
          }));

          if (format === 'csv') {
            this.downloadCSV(data);
          } else if (format === 'pdf') {
            this.downloadPDF(data);
          }

          this.showSuccess(`Transactions exported as ${format.toUpperCase()}`);
        }

        downloadCSV(data) {
          const headers = Object.keys(data[0] || {});
          const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => `"${row[header]}"`).join(',')),
          ].join('\\n');

          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `transactions-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        }

        downloadPDF(data) {
          // Simple PDF export - in production, use a proper PDF library
          const printContent = `
                    <html>
                    <head><title>Transaction Report</title></head>
                    <body>
                        <h1>Transaction Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                        <table border="1" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    ${Object.keys(data[0] || {})
                                      .map(header => `<th style="padding: 8px; text-align: left;">${header}</th>`)
                                      .join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data
                                  .map(
                                    row => `
                                    <tr>
                                        ${Object.values(row)
                                          .map(value => `<td style="padding: 8px;">${value}</td>`)
                                          .join('')}
                                    </tr>
                                `
                                  )
                                  .join('')}
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;

          const printWindow = window.open('', '_blank');
          printWindow.document.write(printContent);
          printWindow.document.close();
          printWindow.print();
        }

        // Utility methods
        getAmountClass(type) {
          switch (type) {
            case 'deposit':
            case 'bonus':
              return 'amount-positive';
            case 'withdrawal':
            case 'fee':
              return 'amount-negative';
            default:
              return 'amount-neutral';
          }
        }

        getAmountPrefix(type) {
          return type === 'withdrawal' || type === 'fee' ? '-' : '+';
        }

        getTransactionIcon(type) {
          const icons = {
            deposit: 'fas fa-arrow-down',
            withdrawal: 'fas fa-arrow-up',
            transfer: 'fas fa-exchange-alt',
            bonus: 'fas fa-gift',
            fee: 'fas fa-minus-circle',
          };
          return icons[type] || 'fas fa-circle';
        }

        getTransactionIconClass(type) {
          const classes = {
            deposit: 'bg-success',
            withdrawal: 'bg-danger',
            transfer: 'bg-info',
            bonus: 'bg-warning',
            fee: 'bg-secondary',
          };
          return classes[type] || 'bg-secondary';
        }

        formatDateTime(date) {
          return date.toLocaleString();
        }

        showLoadingState() {
          $('#loading-overlay').show();
        }

        hideLoadingState() {
          $('#loading-overlay').hide();
        }

        showError(message) {
          const alert = $(`<div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle mr-2"></i>${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>`);

          $('.container-fluid').prepend(alert);
          setTimeout(() => alert.alert('close'), 5000);
        }

        showSuccess(message) {
          const alert = $(`<div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle mr-2"></i>${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>`);

          $('.container-fluid').prepend(alert);
          setTimeout(() => alert.alert('close'), 3000);
        }

        startRealTimeUpdates() {
          // Update data every 60 seconds
          setInterval(() => {
            if (document.visibilityState === 'visible') {
              this.loadTransactionData();
            }
          }, 60000);
        }

        getAuthToken() {
          return localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || '';
        }
      }

      // Global helper functions for modal actions
      function viewCustomer(customerId) {
        console.log('Viewing customer:', customerId);
        // Implement customer view functionality
        window.open(`/customer/${customerId}`, '_blank');
      }

      function viewSimilarTransactions(type) {
        console.log('Viewing similar transactions of type:', type);
        // Filter to show similar transactions
        $(`#transaction-type-filter`).val(type).trigger('change');
        $('#transactionDetailsModal').modal('hide');
      }

      function processRefund(transactionId) {
        if (confirm('Are you sure you want to process a refund for this transaction?')) {
          console.log('Processing refund for:', transactionId);
          // Implement refund processing
          alert('Refund processing initiated for transaction: ' + transactionId);
          $('#transactionDetailsModal').modal('hide');
        }
      }

      // Initialize the dashboard when the page loads
      $(document).ready(() => {
        window.transactionHistoryDashboard = new TransactionHistoryDashboard();
      });
    </script>
  </body>
</html>
