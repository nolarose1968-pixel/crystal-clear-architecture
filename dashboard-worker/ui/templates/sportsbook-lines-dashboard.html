<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sportsbook Lines Dashboard - Live Betting Management</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.js"></script>

    <style>
      .sportsbook-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .dashboard-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 20px;
        border: none;
      }

      .card-header-custom {
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 15px;
        border: none;
      }

      .betting-line-card {
        transition: transform 0.2s ease;
        cursor: pointer;
        border-left: 4px solid;
      }

      .betting-line-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .line-football {
        border-left-color: #28a745;
      }
      .line-basketball {
        border-left-color: #dc3545;
      }
      .line-baseball {
        border-left-color: #17a2b8;
      }
      .line-hockey {
        border-left-color: #ffc107;
      }
      .line-soccer {
        border-left-color: #6c757d;
      }
      .line-tennis {
        border-left-color: #e83e8c;
      }

      .odds-display {
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
        padding: 10px;
        border-radius: 8px;
        margin: 5px 0;
      }

      .odds-positive {
        background: #d4edda;
        color: #155724;
      }
      .odds-negative {
        background: #f8d7da;
        color: #721c24;
      }
      .odds-even {
        background: #d1ecf1;
        color: #0c5460;
      }

      .movement-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 0.9em;
        margin-left: 10px;
      }

      .movement-up {
        color: #28a745;
      }

      .movement-down {
        color: #dc3545;
      }

      .movement-stable {
        color: #6c757d;
      }

      .filter-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .sports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .sports-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease;
      }

      .sports-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .sports-icon {
        font-size: 3em;
        margin-bottom: 15px;
      }

      .sports-name {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .sports-count {
        color: #6c757d;
        font-size: 0.9em;
      }

      .chart-container {
        height: 400px;
        margin-bottom: 20px;
      }

      .betting-lines-modal .modal-dialog {
        max-width: 1000px;
      }

      .search-input {
        position: relative;
      }

      .search-input i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
      }

      .line-management-tools {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        z-index: 10;
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        color: #28a745;
        font-weight: bold;
        font-size: 0.9em;
      }

      .live-indicator::before {
        content: '';
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .odds-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }

      .bookmaker-odds {
        text-align: center;
        padding: 8px;
        border-radius: 6px;
        background: #f8f9fa;
        font-size: 0.9em;
      }

      .best-odds {
        background: #d4edda !important;
        border: 2px solid #28a745;
      }

      .line-history {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
      }

      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
        font-size: 0.9em;
      }

      .history-time {
        color: #6c757d;
        font-size: 0.8em;
      }

      .volume-indicator {
        width: 100%;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 5px;
      }

      .volume-fill {
        height: 100%;
        background: linear-gradient(90deg, #ffc107, #fd7e14);
        transition: width 0.3s ease;
      }

      @media (max-width: 768px) {
        .sports-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .odds-comparison {
          grid-template-columns: repeat(2, 1fr);
        }

        .line-management-tools {
          justify-content: center;
        }

        .filter-section .row > div {
          margin-bottom: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="sportsbook-dashboard">
      <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h2 class="mb-0">
                  <i class="fas fa-trophy mr-2"></i>
                  Sportsbook Lines Dashboard
                  <span class="badge badge-light ml-2" id="system-status">Live</span>
                  <span class="live-indicator ml-2">
                    <span>LIVE</span>
                  </span>
                </h2>
                <p class="mb-0 mt-2 opacity-75">Real-time betting lines management and odds tracking</p>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <div class="form-group search-input">
                      <label for="line-search">Search Lines</label>
                      <input
                        type="text"
                        class="form-control"
                        id="line-search"
                        placeholder="Team name, event, or league"
                      />
                      <i class="fas fa-search"></i>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label for="sport-filter">Sport</label>
                      <select class="form-control" id="sport-filter">
                        <option value="all">All Sports</option>
                        <option value="football">Football</option>
                        <option value="basketball">Basketball</option>
                        <option value="baseball">Baseball</option>
                        <option value="hockey">Hockey</option>
                        <option value="soccer">Soccer</option>
                        <option value="tennis">Tennis</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label for="market-filter">Market Type</label>
                      <select class="form-control" id="market-filter">
                        <option value="all">All Markets</option>
                        <option value="moneyline">Moneyline</option>
                        <option value="spread">Spread</option>
                        <option value="total">Total</option>
                        <option value="prop">Proposition</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-group">
                      <label>Date Range</label>
                      <input type="text" class="form-control" id="date-range-picker" placeholder="Select date range" />
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label>&nbsp;</label>
                      <div class="line-management-tools">
                        <button class="btn btn-outline-primary btn-sm" id="refresh-lines">
                          <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="toggle-auto-refresh">
                          <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="export-lines">
                          <i class="fas fa-file-export"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sports Overview -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="sports-grid" id="sports-grid">
              <!-- Sports cards will be populated by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
          <div class="col-lg-6">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-chart-line mr-2"></i>
                  Line Movement Trends
                </h4>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="lineMovementChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-chart-pie mr-2"></i>
                  Betting Volume by Sport
                </h4>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="volumeBySportChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Betting Lines -->
        <div class="row">
          <div class="col-12">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-list mr-2"></i>
                  Live Betting Lines
                  <span class="badge badge-light ml-2" id="lines-count">0</span>
                </h4>
              </div>
              <div class="card-body position-relative">
                <div id="loading-overlay" class="loading-overlay" style="display: none">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <div class="mt-2">Loading betting lines...</div>
                  </div>
                </div>

                <div id="betting-lines-container">
                  <!-- Betting line cards will be populated here -->
                </div>

                <!-- Pagination -->
                <div class="pagination-custom" id="pagination-container" style="display: none">
                  <button class="page-btn" id="prev-page" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Previous
                  </button>
                  <span id="page-info">Page 1 of 1</span>
                  <button class="page-btn" id="next-page" disabled>
                    Next
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Line Details Modal -->
    <div class="modal fade betting-lines-modal" id="lineDetailsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-trophy mr-2"></i>
              Line Details & Analytics
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body" id="line-details-content">
            <!-- Line details will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" id="place-bet-btn">
              <i class="fas fa-plus mr-1"></i>
              Place Bet
            </button>
            <button type="button" class="btn btn-warning" id="watch-line-btn">
              <i class="fas fa-eye mr-1"></i>
              Watch Line
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bulk Line Management Modal -->
    <div class="modal fade" id="bulkLineManagementModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-cogs mr-2"></i>
              Bulk Line Management
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="bulk-action-type">Action Type</label>
              <select class="form-control" id="bulk-action-type">
                <option value="adjust-odds">Adjust Odds</option>
                <option value="suspend-lines">Suspend Lines</option>
                <option value="resume-lines">Resume Lines</option>
                <option value="update-limits">Update Limits</option>
              </select>
            </div>
            <div class="form-group" id="adjustment-params" style="display: none">
              <label for="adjustment-value">Adjustment Value</label>
              <input type="number" class="form-control" id="adjustment-value" step="0.01" placeholder="0.00" />
            </div>
            <div class="selected-lines" id="selected-lines-list">
              <!-- Selected lines will be listed here -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" id="confirm-bulk-action">
              <i class="fas fa-check mr-1"></i>
              Confirm Action
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Sportsbook Lines JavaScript -->
    <script>
      class SportsbookLinesDashboard {
        constructor() {
          this.lines = [];
          this.filteredLines = [];
          this.sportsData = {};
          this.charts = {};
          this.currentPage = 1;
          this.pageSize = 20;
          this.totalPages = 1;
          this.filters = {
            search: '',
            sport: 'all',
            market: 'all',
            dateRange: null,
          };
          this.autoRefreshEnabled = false;
          this.autoRefreshInterval = null;
          this.selectedLines = [];

          this.initializeEventHandlers();
          this.initializeCharts();
          this.initializeDateRangePicker();
          this.loadInitialData();
          this.startRealTimeUpdates();
        }

        initializeEventHandlers() {
          // Search functionality
          $('#line-search').on('input', e => {
            this.filters.search = e.target.value;
            this.applyFilters();
          });

          // Filter controls
          $('#sport-filter, #market-filter').on('change', () => {
            this.filters.sport = $('#sport-filter').val();
            this.filters.market = $('#market-filter').val();
            this.applyFilters();
          });

          // Refresh and control buttons
          $('#refresh-lines').on('click', () => {
            this.loadBettingLines();
          });

          $('#toggle-auto-refresh').on('click', e => {
            this.toggleAutoRefresh();
            const icon = $(e.currentTarget).find('i');
            if (this.autoRefreshEnabled) {
              icon.removeClass('fa-play').addClass('fa-pause');
              $(e.currentTarget).removeClass('btn-outline-success').addClass('btn-success');
            } else {
              icon.removeClass('fa-pause').addClass('fa-play');
              $(e.currentTarget).removeClass('btn-success').addClass('btn-outline-success');
            }
          });

          $('#export-lines').on('click', () => {
            this.exportLines();
          });

          // Pagination
          $('#prev-page').on('click', () => {
            if (this.currentPage > 1) {
              this.currentPage--;
              this.renderBettingLines();
            }
          });

          $('#next-page').on('click', () => {
            if (this.currentPage < this.totalPages) {
              this.currentPage++;
              this.renderBettingLines();
            }
          });

          // Line card clicks
          $(document).on('click', '.betting-line-card', e => {
            const lineId = $(e.currentTarget).data('line-id');
            this.showLineDetails(lineId);
          });

          // Modal actions
          $('#place-bet-btn').on('click', () => {
            this.placeBet();
          });

          $('#watch-line-btn').on('click', () => {
            this.watchLine();
          });

          $('#confirm-bulk-action').on('click', () => {
            this.confirmBulkAction();
          });

          // Bulk action type change
          $('#bulk-action-type').on('change', e => {
            const actionType = e.target.value;
            const adjustmentParams = $('#adjustment-params');
            if (actionType === 'adjust-odds') {
              adjustmentParams.show();
            } else {
              adjustmentParams.hide();
            }
          });
        }

        initializeCharts() {
          // Line movement chart
          const movementCtx = document.getElementById('lineMovementChart').getContext('2d');
          this.charts.movement = new Chart(movementCtx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'Average Line Movement',
                  data: [],
                  borderColor: '#007bff',
                  backgroundColor: 'rgba(0, 123, 255, 0.1)',
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value > 0 ? '+' + value : value;
                    },
                  },
                },
              },
            },
          });

          // Volume by sport chart
          const volumeCtx = document.getElementById('volumeBySportChart').getContext('2d');
          this.charts.volume = new Chart(volumeCtx, {
            type: 'doughnut',
            data: {
              labels: [],
              datasets: [
                {
                  data: [],
                  backgroundColor: [
                    '#28a745', // Football
                    '#dc3545', // Basketball
                    '#17a2b8', // Baseball
                    '#ffc107', // Hockey
                    '#6c757d', // Soccer
                    '#e83e8c', // Tennis
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                },
              },
            },
          });
        }

        initializeDateRangePicker() {
          $('#date-range-picker').daterangepicker(
            {
              autoApply: true,
              locale: {
                format: 'MM/DD/YYYY',
              },
              ranges: {
                Today: [moment(), moment()],
                Tomorrow: [moment().add(1, 'days'), moment().add(1, 'days')],
                'Next 7 Days': [moment(), moment().add(6, 'days')],
                'This Week': [moment().startOf('week'), moment().endOf('week')],
                'Next Week': [moment().add(1, 'week').startOf('week'), moment().add(1, 'week').endOf('week')],
              },
            },
            (start, end) => {
              this.filters.dateRange = {
                start: start.format('YYYY-MM-DD'),
                end: end.format('YYYY-MM-DD'),
              };
              this.applyFilters();
            }
          );
        }

        async loadInitialData() {
          this.showLoadingState();
          await Promise.all([this.loadBettingLines(), this.loadSportsData()]);
          this.hideLoadingState();
        }

        async loadBettingLines() {
          try {
            // Simulate API call - replace with actual sportsbook API endpoints
            const response = await this.simulateBettingLinesFetch();
            this.lines = response.data;
            this.applyFilters();
            this.updateCharts();
          } catch (error) {
            console.error('Failed to load betting lines:', error);
            this.showError('Failed to load betting lines');
          }
        }

        async simulateBettingLinesFetch() {
          // Mock comprehensive betting lines data
          return new Promise(resolve => {
            setTimeout(() => {
              const sports = ['football', 'basketball', 'baseball', 'hockey', 'soccer', 'tennis'];
              const markets = ['moneyline', 'spread', 'total'];
              const teams = {
                football: ['Chiefs', '49ers', 'Bills', 'Dolphins', 'Packers', 'Bears'],
                basketball: ['Lakers', 'Warriors', 'Celtics', 'Heat', 'Bucks', 'Bulls'],
                baseball: ['Yankees', 'Red Sox', 'Dodgers', 'Giants', 'Mets', 'Phillies'],
                hockey: ['Bruins', 'Maple Leafs', 'Penguins', 'Capitals', 'Oilers', 'Flames'],
                soccer: ['Manchester City', 'Liverpool', 'Real Madrid', 'Barcelona', 'Bayern', 'PSG'],
                tennis: ['Djokovic', 'Alcaraz', 'Medvedev', 'Rune', 'Sinner', 'Tsitsipas'],
              };

              const lines = [];
              const now = new Date();

              // Generate 200 betting lines
              for (let i = 0; i < 200; i++) {
                const sport = sports[Math.floor(Math.random() * sports.length)];
                const market = markets[Math.floor(Math.random() * markets.length)];
                const homeTeam = teams[sport][Math.floor(Math.random() * teams[sport].length)];
                const awayTeam = teams[sport][Math.floor(Math.random() * teams[sport].length)];

                // Ensure different teams
                while (homeTeam === awayTeam) {
                  awayTeam = teams[sport][Math.floor(Math.random() * teams[sport].length)];
                }

                const eventTime = new Date(now.getTime() + Math.random() * 7 * 24 * 60 * 60 * 1000);
                const odds = this.generateOdds(market);
                const movement = Math.random() > 0.7 ? (Math.random() - 0.5) * 0.4 : 0; // -0.2 to +0.2

                lines.push({
                  id: `LINE${String(100000 + i).padStart(6, '0')}`,
                  sport: sport,
                  league:
                    sport === 'football'
                      ? 'NFL'
                      : sport === 'basketball'
                        ? 'NBA'
                        : sport === 'baseball'
                          ? 'MLB'
                          : sport === 'hockey'
                            ? 'NHL'
                            : sport === 'soccer'
                              ? 'Premier League'
                              : 'ATP',
                  eventId: `EVENT${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
                  eventName: `${awayTeam} vs ${homeTeam}`,
                  homeTeam: homeTeam,
                  awayTeam: awayTeam,
                  marketType: market,
                  odds: odds,
                  previousOdds: this.adjustOdds(odds, -movement),
                  movement: movement,
                  volume: Math.floor(Math.random() * 10000) + 1000,
                  eventTime: eventTime.toISOString(),
                  status: Math.random() > 0.9 ? 'suspended' : 'active',
                  bookmaker: ['DraftKings', 'FanDuel', 'BetMGM', 'Caesars'][Math.floor(Math.random() * 4)],
                  lastUpdate: new Date(now.getTime() - Math.random() * 300000).toISOString(), // Last 5 minutes
                  juice: market === 'moneyline' ? 0 : Math.random() * 0.05 + 0.02, // 2-7% juice
                  line:
                    market === 'spread'
                      ? (Math.random() - 0.5) * 14 // -7 to +7
                      : market === 'total'
                        ? Math.random() * 20 + 40
                        : null, // 40-60 total
                });
              }

              resolve({
                data: lines.sort((a, b) => new Date(a.eventTime) - new Date(b.eventTime)),
              });
            }, 1000);
          });
        }

        generateOdds(market) {
          switch (market) {
            case 'moneyline':
              return {
                home: Math.random() > 0.5 ? -(Math.random() * 500 + 100) : Math.random() * 500 + 100,
                away: Math.random() > 0.5 ? -(Math.random() * 500 + 100) : Math.random() * 500 + 100,
              };
            case 'spread':
              const spread = (Math.random() - 0.5) * 14;
              return {
                home: spread > 0 ? -(Math.random() * 200 + 100) : Math.random() * 200 + 100,
                away: spread > 0 ? Math.random() * 200 + 100 : -(Math.random() * 200 + 100),
                spread: spread,
              };
            case 'total':
              const total = Math.random() * 20 + 40;
              return {
                over: -(Math.random() * 200 + 100),
                under: -(Math.random() * 200 + 100),
                total: total,
              };
            default:
              return {};
          }
        }

        adjustOdds(odds, movement) {
          if (!odds) return odds;

          const adjusted = { ...odds };
          Object.keys(adjusted).forEach(key => {
            if (typeof adjusted[key] === 'number' && adjusted[key] !== 0) {
              adjusted[key] += movement * Math.abs(adjusted[key]) * 0.1;
            }
          });
          return adjusted;
        }

        applyFilters() {
          this.filteredLines = this.lines.filter(line => {
            // Search filter
            if (this.filters.search) {
              const searchTerm = this.filters.search.toLowerCase();
              const matches =
                line.eventName.toLowerCase().includes(searchTerm) ||
                line.homeTeam.toLowerCase().includes(searchTerm) ||
                line.awayTeam.toLowerCase().includes(searchTerm) ||
                line.league.toLowerCase().includes(searchTerm);
              if (!matches) return false;
            }

            // Sport filter
            if (this.filters.sport !== 'all' && line.sport !== this.filters.sport) {
              return false;
            }

            // Market filter
            if (this.filters.market !== 'all' && line.marketType !== this.filters.market) {
              return false;
            }

            // Date range filter
            if (this.filters.dateRange) {
              const eventDate = new Date(line.eventTime).toISOString().split('T')[0];
              if (eventDate < this.filters.dateRange.start || eventDate > this.filters.dateRange.end) {
                return false;
              }
            }

            return true;
          });

          this.totalPages = Math.ceil(this.filteredLines.length / this.pageSize);
          this.currentPage = 1;
          this.renderBettingLines();
          this.updateSportsOverview();
        }

        renderBettingLines() {
          const container = $('#betting-lines-container');
          const startIndex = (this.currentPage - 1) * this.pageSize;
          const endIndex = startIndex + this.pageSize;
          const pageLines = this.filteredLines.slice(startIndex, endIndex);

          container.empty();

          if (pageLines.length === 0) {
            container.html(`
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No betting lines found</h5>
                            <p class="text-muted">Try adjusting your search criteria</p>
                        </div>
                    `);
            $('#pagination-container').hide();
            return;
          }

          pageLines.forEach(line => {
            const lineClass = `line-${line.sport}`;
            const timeUntil = this.formatTimeUntil(new Date(line.eventTime));
            const movementIndicator = this.getMovementIndicator(line.movement);
            const oddsDisplay = this.formatOddsDisplay(line);
            const volumePercentage = Math.min((line.volume / 10000) * 100, 100);

            const lineCard = `
                        <div class="betting-line-card mb-3 p-3 border rounded ${lineClass}"
                             data-line-id="${line.id}">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 mr-2">${line.eventName}</h6>
                                        <span class="badge badge-secondary">${line.league}</span>
                                        ${line.status === 'suspended' ? '<span class="badge badge-warning ml-2">SUSPENDED</span>' : ''}
                                    </div>
                                    <p class="mb-2 text-muted small">
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${this.formatDateTime(new Date(line.eventTime))}
                                        <span class="ml-3">${timeUntil}</span>
                                        <span class="ml-3">${line.bookmaker}</span>
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="volume-indicator">
                                        <div class="volume-fill" style="width: ${volumePercentage}%"></div>
                                    </div>
                                    <small class="text-muted">${line.volume.toLocaleString()} bets</small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-8">
                                    <div class="odds-display ${this.getOddsClass(line.marketType)}">
                                        ${oddsDisplay}
                                    </div>
                                </div>
                                <div class="col-md-4 text-right">
                                    <div class="movement-indicator ${this.getMovementClass(line.movement)}">
                                        <i class="${this.getMovementIcon(line.movement)}"></i>
                                        <span>${this.formatMovement(line.movement)}</span>
                                    </div>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-clock mr-1"></i>
                                        ${this.formatTimeAgo(new Date(line.lastUpdate))}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;

            container.append(lineCard);
          });

          // Update pagination
          this.updatePagination();
          $('#pagination-container').show();
          $('#lines-count').text(this.filteredLines.length);
        }

        updatePagination() {
          $('#page-info').text(`Page ${this.currentPage} of ${this.totalPages}`);
          $('#prev-page').prop('disabled', this.currentPage === 1);
          $('#next-page').prop('disabled', this.currentPage === this.totalPages);
        }

        async loadSportsData() {
          // Calculate sports statistics
          this.sportsData = {};
          this.lines.forEach(line => {
            if (!this.sportsData[line.sport]) {
              this.sportsData[line.sport] = {
                count: 0,
                volume: 0,
                activeLines: 0,
              };
            }
            this.sportsData[line.sport].count++;
            this.sportsData[line.sport].volume += line.volume;
            if (line.status === 'active') {
              this.sportsData[line.sport].activeLines++;
            }
          });

          this.renderSportsOverview();
        }

        renderSportsOverview() {
          const grid = $('#sports-grid');

          const sports = [
            { key: 'football', name: 'Football', icon: 'fas fa-football-ball', color: '#28a745' },
            { key: 'basketball', name: 'Basketball', icon: 'fas fa-basketball-ball', color: '#dc3545' },
            { key: 'baseball', name: 'Baseball', icon: 'fas fa-baseball-ball', color: '#17a2b8' },
            { key: 'hockey', name: 'Hockey', icon: 'fas fa-hockey-puck', color: '#ffc107' },
            { key: 'soccer', name: 'Soccer', icon: 'fas fa-futbol', color: '#6c757d' },
            { key: 'tennis', name: 'Tennis', icon: 'fas fa-table-tennis', color: '#e83e8c' },
          ];

          grid.html(
            sports
              .map(sport => {
                const data = this.sportsData[sport.key] || { count: 0, volume: 0, activeLines: 0 };
                return `
                        <div class="sports-card" data-sport="${sport.key}">
                            <div class="sports-icon" style="color: ${sport.color}">
                                <i class="${sport.icon}"></i>
                            </div>
                            <div class="sports-name">${sport.name}</div>
                            <div class="sports-count">
                                ${data.count} lines • ${data.activeLines} active<br>
                                ${data.volume.toLocaleString()} total volume
                            </div>
                        </div>
                    `;
              })
              .join('')
          );

          // Add click handlers for sports cards
          $('.sports-card').on('click', e => {
            const sport = $(e.currentTarget).data('sport');
            $('#sport-filter').val(sport).trigger('change');
          });
        }

        updateSportsOverview() {
          // Update sports data based on filtered lines
          const filteredSportsData = {};
          this.filteredLines.forEach(line => {
            if (!filteredSportsData[line.sport]) {
              filteredSportsData[line.sport] = { count: 0, volume: 0, activeLines: 0 };
            }
            filteredSportsData[line.sport].count++;
            filteredSportsData[line.sport].volume += line.volume;
            if (line.status === 'active') {
              filteredSportsData[line.sport].activeLines++;
            }
          });

          // Update displayed counts
          $('.sports-card').each(function () {
            const sport = $(this).data('sport');
            const data = filteredSportsData[sport] || { count: 0, volume: 0, activeLines: 0 };
            const countElement = $(this).find('.sports-count');
            countElement.html(`
                        ${data.count} lines • ${data.activeLines} active<br>
                        ${data.volume.toLocaleString()} total volume
                    `);
          });
        }

        updateCharts() {
          this.updateMovementChart();
          this.updateVolumeChart();
        }

        updateMovementChart() {
          // Group lines by date and calculate average movement
          const dailyMovement = {};
          const now = new Date();

          for (let i = 29; i >= 0; i--) {
            const date = new Date(now);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            dailyMovement[dateStr] = [];
          }

          this.lines.forEach(line => {
            const dateStr = new Date(line.lastUpdate).toISOString().split('T')[0];
            if (dailyMovement.hasOwnProperty(dateStr)) {
              dailyMovement[dateStr].push(line.movement);
            }
          });

          const labels = Object.keys(dailyMovement);
          const data = labels.map(date => {
            const movements = dailyMovement[date];
            return movements.length > 0 ? movements.reduce((a, b) => a + b, 0) / movements.length : 0;
          });

          this.charts.movement.data.labels = labels.map(date =>
            new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
          );
          this.charts.movement.data.datasets[0].data = data;
          this.charts.movement.update();
        }

        updateVolumeChart() {
          const volumeBySport = {};
          this.lines.forEach(line => {
            volumeBySport[line.sport] = (volumeBySport[line.sport] || 0) + line.volume;
          });

          const labels = Object.keys(volumeBySport).map(sport => sport.charAt(0).toUpperCase() + sport.slice(1));
          const data = Object.values(volumeBySport);

          this.charts.volume.data.labels = labels;
          this.charts.volume.data.datasets[0].data = data;
          this.charts.volume.update();
        }

        showLineDetails(lineId) {
          const line = this.lines.find(l => l.id === lineId);
          if (!line) return;

          const modalContent = `
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Line Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Line ID:</strong></td><td>${line.id}</td></tr>
                                <tr><td><strong>Event:</strong></td><td>${line.eventName}</td></tr>
                                <tr><td><strong>Sport/League:</strong></td><td>${line.sport.charAt(0).toUpperCase() + line.sport.slice(1)} - ${line.league}</td></tr>
                                <tr><td><strong>Market Type:</strong></td><td>${line.marketType.charAt(0).toUpperCase() + line.marketType.slice(1)}</td></tr>
                                <tr><td><strong>Event Time:</strong></td><td>${this.formatDateTime(new Date(line.eventTime))}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="badge badge-${line.status === 'active' ? 'success' : 'warning'}">${line.status}</span></td></tr>
                                <tr><td><strong>Bookmaker:</strong></td><td>${line.bookmaker}</td></tr>
                                <tr><td><strong>Volume:</strong></td><td>${line.volume.toLocaleString()} bets</td></tr>
                                <tr><td><strong>Last Update:</strong></td><td>${this.formatDateTime(new Date(line.lastUpdate))}</td></tr>
                            </table>

                            <h6 class="mt-4">Current Odds</h6>
                            <div class="odds-display ${this.getOddsClass(line.marketType)}">
                                ${this.formatOddsDisplay(line)}
                            </div>

                            <h6 class="mt-4">Line Movement History</h6>
                            <div class="line-history">
                                <div class="history-item">
                                    <span>Current</span>
                                    <span class="history-time">${this.formatTimeAgo(new Date(line.lastUpdate))}</span>
                                </div>
                                <div class="history-item">
                                    <span>Previous: ${this.formatOddsSummary(line.previousOdds)}</span>
                                    <span class="history-time">5 min ago</span>
                                </div>
                                <div class="history-item">
                                    <span>2 hours ago: ${this.formatOddsSummary(this.adjustOdds(line.previousOdds, -0.1))}</span>
                                    <span class="history-time">2 hrs ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6>Quick Stats</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Movement:</strong></td><td class="${this.getMovementClass(line.movement)}">${this.formatMovement(line.movement)}</td></tr>
                                <tr><td><strong>Juice/Vig:</strong></td><td>${line.juice ? (line.juice * 100).toFixed(1) + '%' : 'N/A'}</td></tr>
                                <tr><td><strong>Line:</strong></td><td>${line.line ? line.line.toFixed(1) : 'N/A'}</td></tr>
                                <tr><td><strong>Total:</strong></td><td>${line.odds.total ? line.odds.total.toFixed(1) : 'N/A'}</td></tr>
                            </table>

                            <h6 class="mt-3">Actions</h6>
                            <div class="btn-group-vertical btn-group-sm w-100">
                                <button class="btn btn-outline-success" onclick="placeQuickBet('${line.id}', 'home')">
                                    <i class="fas fa-plus mr-1"></i> Bet ${line.homeTeam}
                                </button>
                                <button class="btn btn-outline-success" onclick="placeQuickBet('${line.id}', 'away')">
                                    <i class="fas fa-plus mr-1"></i> Bet ${line.awayTeam}
                                </button>
                                <button class="btn btn-outline-info" onclick="addToWatchlist('${line.id}')">
                                    <i class="fas fa-eye mr-1"></i> Watch Line
                                </button>
                                <button class="btn btn-outline-warning" onclick="setLineAlert('${line.id}')">
                                    <i class="fas fa-bell mr-1"></i> Set Alert
                                </button>
                            </div>
                        </div>
                    </div>
                `;

          $('#line-details-content').html(modalContent);
          $('#lineDetailsModal').modal('show');
        }

        placeBet() {
          const lineId = $('.betting-line-card').first().data('line-id');
          const line = this.lines.find(l => l.id === lineId);

          if (!line) return;

          const betAmount = prompt('Enter bet amount:', '100');
          if (!betAmount || isNaN(betAmount)) {
            alert('Invalid bet amount');
            return;
          }

          // Simulate bet placement
          this.showSuccess(`Bet placed on ${line.eventName} for $${betAmount}`);
          $('#lineDetailsModal').modal('hide');
        }

        watchLine() {
          const lineId = $('.betting-line-card').first().data('line-id');
          this.showSuccess(`Line ${lineId} added to watchlist`);
          $('#lineDetailsModal').modal('hide');
        }

        toggleAutoRefresh() {
          this.autoRefreshEnabled = !this.autoRefreshEnabled;

          if (this.autoRefreshEnabled) {
            this.autoRefreshInterval = setInterval(() => {
              this.loadBettingLines();
            }, 30000); // Refresh every 30 seconds
            this.showSuccess('Auto-refresh enabled');
          } else {
            if (this.autoRefreshInterval) {
              clearInterval(this.autoRefreshInterval);
              this.autoRefreshInterval = null;
            }
            this.showSuccess('Auto-refresh disabled');
          }
        }

        exportLines() {
          const data = this.filteredLines.map(line => ({
            'Line ID': line.id,
            Sport: line.sport,
            League: line.league,
            Event: line.eventName,
            'Market Type': line.marketType,
            'Home Team': line.homeTeam,
            'Away Team': line.awayTeam,
            Odds: JSON.stringify(line.odds),
            Volume: line.volume,
            Status: line.status,
            Bookmaker: line.bookmaker,
            'Event Time': this.formatDateTime(new Date(line.eventTime)),
            'Last Update': this.formatDateTime(new Date(line.lastUpdate)),
          }));

          this.downloadCSV(data);
          this.showSuccess('Lines exported successfully');
        }

        downloadCSV(data) {
          const headers = Object.keys(data[0] || {});
          const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => `"${row[header]}"`).join(',')),
          ].join('\\n');

          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `sportsbook-lines-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        }

        // Utility methods
        formatTimeUntil(date) {
          const now = new Date();
          const diff = date - now;
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

          if (diff < 0) return 'Started';
          if (hours > 0) return `In ${hours}h ${minutes}m`;
          return `In ${minutes}m`;
        }

        formatDateTime(date) {
          return date.toLocaleString();
        }

        formatTimeAgo(date) {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / (1000 * 60));

          if (diffMins < 1) return 'just now';
          if (diffMins < 60) return `${diffMins} min ago`;
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          if (diffHours < 24) return `${diffHours} hrs ago`;
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          return `${diffDays} days ago`;
        }

        getMovementIndicator(movement) {
          if (movement === 0) return '<span class="movement-stable">No Change</span>';
          const direction = movement > 0 ? 'up' : 'down';
          const absMovement = Math.abs(movement);
          return `<span class="movement-${direction}">${absMovement > 0.1 ? 'Large' : 'Small'} ${direction === 'up' ? 'Increase' : 'Decrease'}</span>`;
        }

        getMovementClass(movement) {
          if (movement > 0.05) return 'movement-up';
          if (movement < -0.05) return 'movement-down';
          return 'movement-stable';
        }

        getMovementIcon(movement) {
          if (movement > 0.05) return 'fas fa-arrow-up';
          if (movement < -0.05) return 'fas fa-arrow-down';
          return 'fas fa-minus';
        }

        formatMovement(movement) {
          if (movement === 0) return '0.00';
          return (movement > 0 ? '+' : '') + movement.toFixed(2);
        }

        formatOddsDisplay(line) {
          switch (line.marketType) {
            case 'moneyline':
              return `
                            <div class="odds-comparison">
                                <div class="bookmaker-odds">${line.homeTeam}<br><strong>${this.formatOddsValue(line.odds.home)}</strong></div>
                                <div class="bookmaker-odds">${line.awayTeam}<br><strong>${this.formatOddsValue(line.odds.away)}</strong></div>
                            </div>
                        `;
            case 'spread':
              return `
                            <div class="odds-comparison">
                                <div class="bookmaker-odds">${line.homeTeam} ${line.odds.spread > 0 ? '+' : ''}${line.odds.spread}<br><strong>${this.formatOddsValue(line.odds.home)}</strong></div>
                                <div class="bookmaker-odds">${line.awayTeam} ${line.odds.spread < 0 ? '' : '+'}${line.odds.spread * -1}<br><strong>${this.formatOddsValue(line.odds.away)}</strong></div>
                            </div>
                        `;
            case 'total':
              return `
                            <div class="odds-comparison">
                                <div class="bookmaker-odds">Over ${line.odds.total}<br><strong>${this.formatOddsValue(line.odds.over)}</strong></div>
                                <div class="bookmaker-odds">Under ${line.odds.total}<br><strong>${this.formatOddsValue(line.odds.under)}</strong></div>
                            </div>
                        `;
            default:
              return 'Odds not available';
          }
        }

        formatOddsValue(odds) {
          if (!odds) return 'N/A';
          if (odds > 0) return `+${odds.toFixed(0)}`;
          return odds.toFixed(0);
        }

        formatOddsSummary(odds) {
          if (!odds) return 'N/A';
          if (odds.home && odds.away) {
            return `${this.formatOddsValue(odds.home)} / ${this.formatOddsValue(odds.away)}`;
          }
          return 'N/A';
        }

        getOddsClass(marketType) {
          switch (marketType) {
            case 'moneyline':
              return 'odds-even';
            case 'spread':
              return 'odds-neutral';
            case 'total':
              return 'odds-neutral';
            default:
              return 'odds-neutral';
          }
        }

        showLoadingState() {
          $('#loading-overlay').show();
        }

        hideLoadingState() {
          $('#loading-overlay').hide();
        }

        showError(message) {
          const alert = $(`<div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle mr-2"></i>${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>`);

          $('.container-fluid').prepend(alert);
          setTimeout(() => alert.alert('close'), 5000);
        }

        showSuccess(message) {
          const alert = $(`<div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle mr-2"></i>${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>`);

          $('.container-fluid').prepend(alert);
          setTimeout(() => alert.alert('close'), 3000);
        }

        startRealTimeUpdates() {
          // Update data every 60 seconds if auto-refresh is disabled
          setInterval(() => {
            if (!this.autoRefreshEnabled && document.visibilityState === 'visible') {
              this.loadBettingLines();
            }
          }, 60000);
        }
      }

      // Global helper functions for modal actions
      function placeQuickBet(lineId, side) {
        const betAmount = prompt('Enter bet amount:', '100');
        if (!betAmount || isNaN(betAmount)) {
          alert('Invalid bet amount');
          return;
        }

        // Simulate bet placement
        window.sportsbookDashboard.showSuccess(`Quick bet placed for $${betAmount}`);
        $('#lineDetailsModal').modal('hide');
      }

      function addToWatchlist(lineId) {
        window.sportsbookDashboard.showSuccess(`Line ${lineId} added to watchlist`);
        $('#lineDetailsModal').modal('hide');
      }

      function setLineAlert(lineId) {
        const threshold = prompt('Enter movement threshold (e.g., 0.05):', '0.05');
        if (!threshold || isNaN(threshold)) {
          alert('Invalid threshold');
          return;
        }

        window.sportsbookDashboard.showSuccess(`Alert set for line ${lineId} with threshold ${threshold}`);
        $('#lineDetailsModal').modal('hide');
      }

      // Initialize the dashboard when the page loads
      $(document).ready(() => {
        window.sportsbookDashboard = new SportsbookLinesDashboard();
      });
    </script>
  </body>
</html>
