<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Collections Dashboard - Settlement Management</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.js"></script>

    <style>
      .collections-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .dashboard-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 20px;
        border: none;
      }

      .card-header-custom {
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 15px;
        border: none;
      }

      .settlement-card {
        transition: transform 0.2s ease;
        cursor: pointer;
        border-left: 4px solid;
      }

      .settlement-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .settlement-pending {
        border-left-color: #ffc107;
      }
      .settlement-win {
        border-left-color: #28a745;
      }
      .settlement-loss {
        border-left-color: #dc3545;
      }
      .settlement-push {
        border-left-color: #17a2b8;
      }
      .settlement-void {
        border-left-color: #6c757d;
      }

      .settlement-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
      }

      .amount-positive {
        color: #28a745;
        font-weight: bold;
      }

      .amount-negative {
        color: #dc3545;
        font-weight: bold;
      }

      .amount-neutral {
        color: #6c757d;
        font-weight: bold;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: bold;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-win {
        background: #d4edda;
        color: #155724;
      }
      .status-loss {
        background: #f8d7da;
        color: #721c24;
      }
      .status-push {
        background: #d1ecf1;
        color: #0c5460;
      }
      .status-void {
        background: #e2e3e5;
        color: #383d41;
      }

      .filter-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .collections-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .collections-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
      }

      .collections-value {
        font-size: 2.5em;
        font-weight: bold;
        margin: 10px 0;
      }

      .collections-label {
        color: #6c757d;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .chart-container {
        height: 400px;
        margin-bottom: 20px;
      }

      .settlement-details-modal .modal-dialog {
        max-width: 900px;
      }

      .search-input {
        position: relative;
      }

      .search-input i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
      }

      .bulk-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        z-index: 10;
      }

      .settlement-timeline {
        position: relative;
        padding-left: 30px;
      }

      .timeline-item {
        position: relative;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border-left: 3px solid;
      }

      .timeline-item::before {
        content: '';
        position: absolute;
        left: -38px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: white;
        border: 2px solid #dee2e6;
      }

      .timeline-item.pending {
        border-left-color: #ffc107;
      }
      .timeline-item.win {
        border-left-color: #28a745;
      }
      .timeline-item.loss {
        border-left-color: #dc3545;
      }
      .timeline-item.push {
        border-left-color: #17a2b8;
      }
      .timeline-item.void {
        border-left-color: #6c757d;
      }

      .timeline-item.pending::before {
        border-color: #ffc107;
        background: #ffc107;
      }
      .timeline-item.win::before {
        border-color: #28a745;
        background: #28a745;
      }
      .timeline-item.loss::before {
        border-color: #dc3545;
        background: #dc3545;
      }
      .timeline-item.push::before {
        border-color: #17a2b8;
        background: #17a2b8;
      }
      .timeline-item.void::before {
        border-color: #6c757d;
        background: #6c757d;
      }

      .risk-indicator {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        overflow: hidden;
      }

      .risk-fill {
        height: 100%;
        transition: width 0.3s ease;
      }

      .risk-low {
        background: #28a745;
      }
      .risk-medium {
        background: #ffc107;
      }
      .risk-high {
        background: #fd7e14;
      }
      .risk-critical {
        background: #dc3545;
      }

      @media (max-width: 768px) {
        .collections-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .bulk-actions {
          justify-content: center;
        }

        .filter-section .row > div {
          margin-bottom: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="collections-dashboard">
      <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h2 class="mb-0">
                  <i class="fas fa-calendar-check mr-2"></i>
                  Collections Dashboard
                  <span class="badge badge-light ml-2" id="system-status">Active</span>
                </h2>
                <p class="mb-0 mt-2 opacity-75">Settlement management and collections performance analytics</p>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <div class="form-group search-input">
                      <label for="settlement-search">Search Settlements</label>
                      <input
                        type="text"
                        class="form-control"
                        id="settlement-search"
                        placeholder="Wager ID, Customer ID, or Amount"
                      />
                      <i class="fas fa-search"></i>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label for="settlement-type-filter">Settlement Type</label>
                      <select class="form-control" id="settlement-type-filter">
                        <option value="all">All Types</option>
                        <option value="win">Wins</option>
                        <option value="loss">Losses</option>
                        <option value="push">Pushes</option>
                        <option value="void">Voids</option>
                        <option value="pending">Pending</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label for="status-filter">Status</label>
                      <select class="form-control" id="status-filter">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-group">
                      <label>Date Range</label>
                      <input type="text" class="form-control" id="date-range-picker" placeholder="Select date range" />
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="form-group">
                      <label>&nbsp;</label>
                      <div class="bulk-actions">
                        <button class="btn btn-outline-primary btn-sm" id="refresh-data">
                          <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="bulk-settle">
                          <i class="fas fa-check-double"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="export-settlements">
                          <i class="fas fa-file-export"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Collections Analytics -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="collections-grid" id="collections-grid">
              <!-- Collections analytics cards will be populated by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
          <div class="col-lg-6">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-chart-line mr-2"></i>
                  Settlement Trends
                </h4>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="settlementTrendsChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-chart-pie mr-2"></i>
                  Settlement Distribution
                </h4>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="settlementTypeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Settlement List -->
        <div class="row">
          <div class="col-12">
            <div class="dashboard-card">
              <div class="card-header-custom">
                <h4 class="mb-0">
                  <i class="fas fa-list mr-2"></i>
                  Settlement Queue
                  <span class="badge badge-light ml-2" id="settlement-count">0</span>
                </h4>
              </div>
              <div class="card-body position-relative">
                <div id="loading-overlay" class="loading-overlay" style="display: none">
                  <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <div class="mt-2">Loading settlements...</div>
                  </div>
                </div>

                <div id="settlement-container">
                  <!-- Settlement cards will be populated here -->
                </div>

                <!-- Pagination -->
                <div class="pagination-custom" id="pagination-container" style="display: none">
                  <button class="page-btn" id="prev-page" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Previous
                  </button>
                  <span id="page-info">Page 1 of 1</span>
                  <button class="page-btn" id="next-page" disabled>
                    Next
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settlement Details Modal -->
    <div class="modal fade settlement-details-modal" id="settlementDetailsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-receipt mr-2"></i>
              Settlement Details
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body" id="settlement-details-content">
            <!-- Settlement details will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success" id="settle-wager-btn">
              <i class="fas fa-check mr-1"></i>
              Settle Wager
            </button>
            <button type="button" class="btn btn-warning" id="bulk-settle-selected" style="display: none">
              <i class="fas fa-check-double mr-1"></i>
              Bulk Settle Selected
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bulk Settlement Modal -->
    <div class="modal fade" id="bulkSettlementModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-check-double mr-2"></i>
              Bulk Settlement
            </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="bulk-settlement-type">Settlement Type</label>
              <select class="form-control" id="bulk-settlement-type">
                <option value="win">Win</option>
                <option value="loss">Loss</option>
                <option value="push">Push</option>
                <option value="void">Void</option>
              </select>
            </div>
            <div class="form-group">
              <label for="bulk-notes">Notes (Optional)</label>
              <textarea
                class="form-control"
                id="bulk-notes"
                rows="3"
                placeholder="Add notes for this bulk settlement..."
              ></textarea>
            </div>
            <div class="selected-wagers" id="selected-wagers-list">
              <!-- Selected wagers will be listed here -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" id="confirm-bulk-settlement">
              <i class="fas fa-check-double mr-1"></i>
              Confirm Bulk Settlement
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Collections Dashboard JavaScript -->
    <script>
      class CollectionsDashboard {
        constructor() {
          this.settlements = [];
          this.filteredSettlements = [];
          this.analytics = {};
          this.charts = {};
          this.currentPage = 1;
          this.pageSize = 20;
          this.totalPages = 1;
          this.filters = {
            search: '',
            type: 'all',
            status: 'all',
            dateRange: null,
          };
          this.selectedSettlements = [];

          this.initializeEventHandlers();
          this.initializeCharts();
          this.initializeDateRangePicker();
          this.loadInitialData();
          this.startRealTimeUpdates();
        }

        initializeEventHandlers() {
          // Search functionality
          $('#settlement-search').on('input', e => {
            this.filters.search = e.target.value;
            this.applyFilters();
          });

          // Filter controls
          $('#settlement-type-filter, #status-filter').on('change', () => {
            this.filters.type = $('#settlement-type-filter').val();
            this.filters.status = $('#status-filter').val();
            this.applyFilters();
          });

          // Refresh button
          $('#refresh-data').on('click', () => {
            this.loadSettlementData();
          });

          // Bulk actions
          $('#bulk-settle').on('click', () => {
            this.showBulkSettlementModal();
          });

          $('#export-settlements').on('click', () => {
            this.exportSettlements();
          });

          // Pagination
          $('#prev-page').on('click', () => {
            if (this.currentPage > 1) {
              this.currentPage--;
              this.renderSettlements();
            }
          });

          $('#next-page').on('click', () => {
            if (this.currentPage < this.totalPages) {
              this.currentPage++;
              this.renderSettlements();
            }
          });

          // Settlement card clicks
          $(document).on('click', '.settlement-card', e => {
            const wagerId = $(e.currentTarget).data('wager-id');
            this.showSettlementDetails(wagerId);
          });

          // Modal actions
          $('#settle-wager-btn').on('click', () => {
            this.settleWager();
          });

          $('#confirm-bulk-settlement').on('click', () => {
            this.confirmBulkSettlement();
          });

          // Checkbox selections for bulk operations
          $(document).on('change', '.settlement-checkbox', e => {
            const wagerId = $(e.target).data('wager-id');
            if (e.target.checked) {
              this.selectedSettlements.push(wagerId);
            } else {
              this.selectedSettlements = this.selectedSettlements.filter(id => id !== wagerId);
            }
            this.updateBulkActionsVisibility();
          });
        }

        initializeCharts() {
          // Settlement trends chart
          const trendCtx = document.getElementById('settlementTrendsChart').getContext('2d');
          this.charts.trends = new Chart(trendCtx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'Daily Settlements',
                  data: [],
                  borderColor: '#007bff',
                  backgroundColor: 'rgba(0, 123, 255, 0.1)',
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });

          // Settlement types chart
          const typeCtx = document.getElementById('settlementTypeChart').getContext('2d');
          this.charts.types = new Chart(typeCtx, {
            type: 'doughnut',
            data: {
              labels: [],
              datasets: [
                {
                  data: [],
                  backgroundColor: [
                    '#28a745', // win
                    '#dc3545', // loss
                    '#17a2b8', // push
                    '#6c757d', // void
                    '#ffc107', // pending
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                },
              },
            },
          });
        }

        initializeDateRangePicker() {
          $('#date-range-picker').daterangepicker(
            {
              autoApply: true,
              locale: {
                format: 'MM/DD/YYYY',
              },
              ranges: {
                Today: [moment(), moment()],
                Yesterday: [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [
                  moment().subtract(1, 'month').startOf('month'),
                  moment().subtract(1, 'month').endOf('month'),
                ],
              },
            },
            (start, end) => {
              this.filters.dateRange = {
                start: start.format('YYYY-MM-DD'),
                end: end.format('YYYY-MM-DD'),
              };
              this.applyFilters();
            }
          );
        }

        async loadInitialData() {
          this.showLoadingState();
          await Promise.all([this.loadSettlementData(), this.loadAnalytics()]);
          this.hideLoadingState();
        }

        async loadSettlementData() {
          try {
            // Simulate API call - replace with actual settlement API endpoints
            const response = await this.simulateSettlementDataFetch();
            this.settlements = response.data;
            this.applyFilters();
            this.updateCharts();
          } catch (error) {
            console.error('Failed to load settlement data:', error);
            this.showError('Failed to load settlement data');
          }
        }

        async simulateSettlementDataFetch() {
          // Mock comprehensive settlement data
          return new Promise(resolve => {
            setTimeout(() => {
              const settlements = [];
              const types = ['win', 'loss', 'push', 'void'];
              const statuses = ['pending', 'completed'];
              const descriptions = [
                'Football Moneyline',
                'Basketball Spread',
                'Baseball Total',
                'Soccer Over/Under',
                'Tennis Match',
                'Hockey Puck Line',
              ];

              // Generate last 200 settlements
              for (let i = 0; i < 200; i++) {
                const type = i < 50 ? 'pending' : types[Math.floor(Math.random() * types.length)];
                const status = i < 50 ? 'pending' : 'completed';
                const amount = Math.random() * 500 + 50; // $50 to $550
                const toWinAmount = amount * (Math.random() * 2 + 1); // 1x to 3x payout
                const daysAgo = Math.floor(Math.random() * 30); // Last 30 days

                settlements.push({
                  wagerNumber: `W${String(100000 + i).padStart(6, '0')}`,
                  customerId: `CUST${String(Math.floor(Math.random() * 1000)).padStart(4, '0')}`,
                  customerName: `Customer ${Math.floor(Math.random() * 1000)}`,
                  type: type,
                  status: status,
                  amountWagered: parseFloat(amount.toFixed(2)),
                  toWinAmount: parseFloat(toWinAmount.toFixed(2)),
                  settlementAmount: type === 'win' ? parseFloat(toWinAmount.toFixed(2)) : 0,
                  description: descriptions[Math.floor(Math.random() * descriptions.length)],
                  createdAt: new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000).toISOString(),
                  settledAt:
                    status === 'completed'
                      ? new Date(Date.now() - Math.floor(Math.random() * daysAgo) * 24 * 60 * 60 * 1000).toISOString()
                      : null,
                  settledBy: status === 'completed' ? `Agent${Math.floor(Math.random() * 10) + 1}` : null,
                  notes: Math.random() > 0.7 ? 'Customer requested settlement confirmation' : null,
                  riskLevel: Math.random() > 0.8 ? 'high' : Math.random() > 0.6 ? 'medium' : 'low',
                });
              }

              resolve({
                data: settlements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)),
              });
            }, 1000);
          });
        }

        applyFilters() {
          this.filteredSettlements = this.settlements.filter(settlement => {
            // Search filter
            if (this.filters.search) {
              const searchTerm = this.filters.search.toLowerCase();
              const matches =
                settlement.wagerNumber.toLowerCase().includes(searchTerm) ||
                settlement.customerId.toLowerCase().includes(searchTerm) ||
                settlement.customerName.toLowerCase().includes(searchTerm) ||
                settlement.description.toLowerCase().includes(searchTerm);
              if (!matches) return false;
            }

            // Type filter
            if (this.filters.type !== 'all') {
              if (this.filters.type === 'pending' && settlement.status !== 'pending') return false;
              if (this.filters.type !== 'pending' && settlement.type !== this.filters.type) return false;
            }

            // Status filter
            if (this.filters.status !== 'all' && settlement.status !== this.filters.status) {
              return false;
            }

            // Date range filter
            if (this.filters.dateRange) {
              const settlementDate = settlement.settledAt || settlement.createdAt;
              const dateStr = new Date(settlementDate).toISOString().split('T')[0];
              if (dateStr < this.filters.dateRange.start || dateStr > this.filters.dateRange.end) {
                return false;
              }
            }

            return true;
          });

          this.totalPages = Math.ceil(this.filteredSettlements.length / this.pageSize);
          this.currentPage = 1;
          this.renderSettlements();
          this.updateAnalytics();
        }

        renderSettlements() {
          const container = $('#settlement-container');
          const startIndex = (this.currentPage - 1) * this.pageSize;
          const endIndex = startIndex + this.pageSize;
          const pageSettlements = this.filteredSettlements.slice(startIndex, endIndex);

          container.empty();

          if (pageSettlements.length === 0) {
            container.html(`
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No settlements found</h5>
                            <p class="text-muted">Try adjusting your search criteria</p>
                        </div>
                    `);
            $('#pagination-container').hide();
            return;
          }

          pageSettlements.forEach(settlement => {
            const amountClass = this.getSettlementAmountClass(settlement);
            const amountDisplay = this.getSettlementAmountDisplay(settlement);
            const statusClass = `status-${settlement.status}`;
            const typeClass = `settlement-${settlement.type}`;
            const iconClass = this.getSettlementIconClass(settlement.type);

            const settlementCard = `
                        <div class="settlement-card mb-3 p-3 border rounded ${typeClass}"
                             data-wager-id="${settlement.wagerNumber}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    ${
                                      this.filters.type === 'pending'
                                        ? `
                                        <input type="checkbox" class="settlement-checkbox mr-3"
                                               data-wager-id="${settlement.wagerNumber}">
                                    `
                                        : ''
                                    }
                                    <div class="settlement-icon ${iconClass} mr-3">
                                        <i class="${this.getSettlementIcon(settlement.type)}"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">${settlement.description}</h6>
                                        <small class="text-muted">
                                            ${settlement.wagerNumber} • ${settlement.customerName} (${settlement.customerId})
                                        </small>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="status-badge ${statusClass}">${settlement.status}</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>Wagered:</strong> $${settlement.amountWagered.toFixed(2)}
                                    </p>
                                    <p class="mb-1">
                                        <strong>To Win:</strong> $${settlement.toWinAmount.toFixed(2)}
                                    </p>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${this.formatDateTime(new Date(settlement.createdAt))}
                                    </small>
                                </div>
                                <div class="col-md-6 text-right">
                                    <div class="amount-value ${amountClass} h5 mb-1">
                                        ${amountDisplay}
                                    </div>
                                    <div class="risk-indicator mb-1">
                                        <div class="risk-fill risk-${settlement.riskLevel}"
                                             style="width: ${this.getRiskPercentage(settlement.riskLevel)}%"></div>
                                    </div>
                                    <small class="text-muted">${settlement.riskLevel} risk</small>
                                </div>
                            </div>
                        </div>
                    `;

            container.append(settlementCard);
          });

          // Update pagination
          this.updatePagination();
          $('#pagination-container').show();
          $('#settlement-count').text(this.filteredSettlements.length);
        }

        updatePagination() {
          $('#page-info').text(`Page ${this.currentPage} of ${this.totalPages}`);
          $('#prev-page').prop('disabled', this.currentPage === 1);
          $('#next-page').prop('disabled', this.currentPage === this.totalPages);
        }

        async loadAnalytics() {
          // Calculate analytics from settlement data
          this.analytics = {
            totalSettlements: this.settlements.length,
            pendingSettlements: this.settlements.filter(s => s.status === 'pending').length,
            completedSettlements: this.settlements.filter(s => s.status === 'completed').length,
            totalWagered: this.settlements.reduce((sum, s) => sum + s.amountWagered, 0),
            totalPaid: this.settlements.reduce((sum, s) => sum + s.settlementAmount, 0),
            winRate:
              this.settlements.length > 0
                ? (this.settlements.filter(s => s.type === 'win').length / this.settlements.length) * 100
                : 0,
            houseProfit: this.settlements.reduce((sum, s) => {
              if (s.type === 'win') return sum - s.settlementAmount;
              return sum + s.amountWagered;
            }, 0),
          };

          this.renderAnalytics();
        }

        updateAnalytics() {
          // Update analytics based on filtered data
          const filtered = this.filteredSettlements;
          this.analytics.filteredTotal = filtered.length;
          this.analytics.filteredWagered = filtered.reduce((sum, s) => sum + s.amountWagered, 0);
          this.analytics.filteredPaid = filtered.reduce((sum, s) => sum + s.settlementAmount, 0);
          this.renderAnalytics();
        }

        renderAnalytics() {
          const analytics = this.analytics;
          const grid = $('#collections-grid');

          grid.html(`
                    <div class="collections-card">
                        <div class="collections-value">${analytics.totalSettlements.toLocaleString()}</div>
                        <div class="collections-label">Total Settlements</div>
                        ${
                          analytics.filteredTotal !== undefined &&
                          analytics.filteredTotal !== analytics.totalSettlements
                            ? `<small class="text-muted">Filtered: ${analytics.filteredTotal.toLocaleString()}</small>`
                            : ''
                        }
                    </div>
                    <div class="collections-card">
                        <div class="collections-value text-warning">${analytics.pendingSettlements}</div>
                        <div class="collections-label">Pending Settlements</div>
                    </div>
                    <div class="collections-card">
                        <div class="collections-value text-success">$${analytics.totalWagered.toLocaleString()}</div>
                        <div class="collections-label">Total Wagered</div>
                        ${
                          analytics.filteredWagered !== undefined &&
                          analytics.filteredWagered !== analytics.totalWagered
                            ? `<small class="text-muted">Filtered: $${analytics.filteredWagered.toLocaleString()}</small>`
                            : ''
                        }
                    </div>
                    <div class="collections-card">
                        <div class="collections-value text-info">$${analytics.totalPaid.toLocaleString()}</div>
                        <div class="collections-label">Total Paid Out</div>
                        ${
                          analytics.filteredPaid !== undefined && analytics.filteredPaid !== analytics.totalPaid
                            ? `<small class="text-muted">Filtered: $${analytics.filteredPaid.toLocaleString()}</small>`
                            : ''
                        }
                    </div>
                    <div class="collections-card">
                        <div class="collections-value text-primary">${analytics.winRate.toFixed(1)}%</div>
                        <div class="collections-label">Win Rate</div>
                    </div>
                    <div class="collections-card">
                        <div class="collections-value ${analytics.houseProfit >= 0 ? 'text-success' : 'text-danger'}">
                            ${analytics.houseProfit >= 0 ? '+' : ''}$${analytics.houseProfit.toLocaleString()}
                        </div>
                        <div class="collections-label">House Profit</div>
                    </div>
                `);
        }

        updateCharts() {
          this.updateTrendsChart();
          this.updateTypesChart();
        }

        updateTrendsChart() {
          // Group settlements by date for the last 30 days
          const last30Days = {};
          const now = new Date();

          for (let i = 29; i >= 0; i--) {
            const date = new Date(now);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            last30Days[dateStr] = 0;
          }

          // Count settlements per day
          this.settlements.forEach(settlement => {
            const dateStr = new Date(settlement.settledAt || settlement.createdAt).toISOString().split('T')[0];
            if (last30Days.hasOwnProperty(dateStr)) {
              last30Days[dateStr]++;
            }
          });

          const labels = Object.keys(last30Days);
          const data = Object.values(last30Days);

          this.charts.trends.data.labels = labels.map(date =>
            new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
          );
          this.charts.trends.data.datasets[0].data = data;
          this.charts.trends.update();
        }

        updateTypesChart() {
          // Count settlements by type
          const typeCounts = {};
          this.settlements.forEach(settlement => {
            const key = settlement.status === 'pending' ? 'pending' : settlement.type;
            typeCounts[key] = (typeCounts[key] || 0) + 1;
          });

          const labels = Object.keys(typeCounts).map(type => type.charAt(0).toUpperCase() + type.slice(1));
          const data = Object.values(typeCounts);

          this.charts.types.data.labels = labels;
          this.charts.types.data.datasets[0].data = data;
          this.charts.types.update();
        }

        showSettlementDetails(wagerId) {
          const settlement = this.settlements.find(s => s.wagerNumber === wagerId);
          if (!settlement) return;

          const modalContent = `
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Settlement Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Wager Number:</strong></td><td>${settlement.wagerNumber}</td></tr>
                                <tr><td><strong>Description:</strong></td><td>${settlement.description}</td></tr>
                                <tr><td><strong>Type:</strong></td><td>${settlement.type.charAt(0).toUpperCase() + settlement.type.slice(1)}</td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="status-badge status-${settlement.status}">${settlement.status}</span></td></tr>
                                <tr><td><strong>Amount Wagered:</strong></td><td>$${settlement.amountWagered.toFixed(2)}</td></tr>
                                <tr><td><strong>To Win Amount:</strong></td><td>$${settlement.toWinAmount.toFixed(2)}</td></tr>
                                <tr><td><strong>Settlement Amount:</strong></td><td class="${this.getSettlementAmountClass(settlement)}">$${settlement.settlementAmount.toFixed(2)}</td></tr>
                                <tr><td><strong>Created:</strong></td><td>${this.formatDateTime(new Date(settlement.createdAt))}</td></tr>
                                ${settlement.settledAt ? `<tr><td><strong>Settled:</strong></td><td>${this.formatDateTime(new Date(settlement.settledAt))}</td></tr>` : ''}
                                ${settlement.settledBy ? `<tr><td><strong>Settled By:</strong></td><td>${settlement.settledBy}</td></tr>` : ''}
                            </table>
                        </div>
                        <div class="col-md-4">
                            <h6>Customer Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Customer ID:</strong></td><td>${settlement.customerId}</td></tr>
                                <tr><td><strong>Name:</strong></td><td>${settlement.customerName}</td></tr>
                                <tr><td><strong>Risk Level:</strong></td><td><span class="status-badge status-${settlement.riskLevel}">${settlement.riskLevel}</span></td></tr>
                            </table>

                            <h6 class="mt-3">Risk Assessment</h6>
                            <div class="risk-indicator mb-2">
                                <div class="risk-fill risk-${settlement.riskLevel}"
                                     style="width: ${this.getRiskPercentage(settlement.riskLevel)}%"></div>
                            </div>
                            <small class="text-muted">${settlement.riskLevel} risk level</small>

                            ${
                              settlement.notes
                                ? `
                                <h6 class="mt-3">Notes</h6>
                                <p class="text-muted small">${settlement.notes}</p>
                            `
                                : ''
                            }
                        </div>
                    </div>
                `;

          $('#settlement-details-content').html(modalContent);
          $('#settlementDetailsModal').modal('show');
        }

        settleWager() {
          const wagerId = $('.settlement-card').first().data('wager-id');
          const settlement = this.settlements.find(s => s.wagerNumber === wagerId);

          if (!settlement) return;

          const settlementType = prompt('Enter settlement type (win/loss/push/void):', settlement.type);
          if (!settlementType || !['win', 'loss', 'push', 'void'].includes(settlementType)) {
            alert('Invalid settlement type. Must be win, loss, push, or void.');
            return;
          }

          const notes = prompt('Enter settlement notes (optional):', settlement.notes || '');

          // Simulate settlement process
          this.showSuccess(`Settlement processed for wager ${wagerId}`);
          $('#settlementDetailsModal').modal('hide');

          // Update settlement in local data
          settlement.status = 'completed';
          settlement.type = settlementType;
          settlement.settledAt = new Date().toISOString();
          settlement.settledBy = 'Current User';
          settlement.notes = notes;
          settlement.settlementAmount = settlementType === 'win' ? settlement.toWinAmount : 0;

          this.applyFilters();
        }

        showBulkSettlementModal() {
          if (this.selectedSettlements.length === 0) {
            alert('Please select settlements to process in bulk.');
            return;
          }

          const selectedWagers = this.settlements.filter(s => this.selectedSettlements.includes(s.wagerNumber));

          const wagersList = selectedWagers
            .map(
              wager => `
                    <div class="alert alert-info py-2 px-3 mb-1">
                        <strong>${wager.wagerNumber}</strong> - ${wager.description} - $${wager.amountWagered.toFixed(2)}
                    </div>
                `
            )
            .join('');

          $('#selected-wagers-list').html(wagersList);
          $('#bulkSettlementModal').modal('show');
        }

        confirmBulkSettlement() {
          const settlementType = $('#bulk-settlement-type').val();
          const notes = $('#bulk-notes').val();

          if (!settlementType) {
            alert('Please select a settlement type.');
            return;
          }

          // Process bulk settlement
          this.selectedSettlements.forEach(wagerId => {
            const settlement = this.settlements.find(s => s.wagerNumber === wagerId);
            if (settlement) {
              settlement.status = 'completed';
              settlement.type = settlementType;
              settlement.settledAt = new Date().toISOString();
              settlement.settledBy = 'Current User (Bulk)';
              settlement.notes = notes;
              settlement.settlementAmount = settlementType === 'win' ? settlement.toWinAmount : 0;
            }
          });

          this.selectedSettlements = [];
          $('#bulkSettlementModal').modal('hide');
          this.showSuccess(`Bulk settlement completed for ${this.selectedSettlements.length} wagers`);
          this.applyFilters();
        }

        updateBulkActionsVisibility() {
          if (this.selectedSettlements.length > 0) {
            $('#bulk-settle-selected').show();
          } else {
            $('#bulk-settle-selected').hide();
          }
        }

        exportSettlements() {
          const data = this.filteredSettlements.map(s => ({
            'Wager Number': s.wagerNumber,
            'Customer ID': s.customerId,
            'Customer Name': s.customerName,
            Description: s.description,
            Type: s.type,
            Status: s.status,
            'Amount Wagered': s.amountWagered,
            'To Win Amount': s.toWinAmount,
            'Settlement Amount': s.settlementAmount,
            'Created Date': this.formatDateTime(new Date(s.createdAt)),
            'Settled Date': s.settledAt ? this.formatDateTime(new Date(s.settledAt)) : '',
            'Settled By': s.settledBy || '',
            'Risk Level': s.riskLevel,
            Notes: s.notes || '',
          }));

          this.downloadCSV(data);
          this.showSuccess('Settlements exported successfully');
        }

        downloadCSV(data) {
          const headers = Object.keys(data[0] || {});
          const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => `"${row[header]}"`).join(',')),
          ].join('\\n');

          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `settlements-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        }

        // Utility methods
        getSettlementAmountClass(settlement) {
          if (settlement.status === 'pending') return 'amount-neutral';
          if (settlement.type === 'win') return 'amount-positive';
          if (settlement.type === 'loss') return 'amount-negative';
          return 'amount-neutral';
        }

        getSettlementAmountDisplay(settlement) {
          if (settlement.status === 'pending') {
            return `$${settlement.amountWagered.toFixed(2)}`;
          }
          if (settlement.type === 'win') {
            return `+$${settlement.settlementAmount.toFixed(2)}`;
          }
          if (settlement.type === 'loss') {
            return `-$${settlement.amountWagered.toFixed(2)}`;
          }
          return '$0.00';
        }

        getSettlementIcon(type) {
          const icons = {
            win: 'fas fa-trophy',
            loss: 'fas fa-times-circle',
            push: 'fas fa-minus-circle',
            void: 'fas fa-ban',
            pending: 'fas fa-clock',
          };
          return icons[type] || 'fas fa-circle';
        }

        getSettlementIconClass(type) {
          const classes = {
            win: 'bg-success',
            loss: 'bg-danger',
            push: 'bg-info',
            void: 'bg-secondary',
            pending: 'bg-warning',
          };
          return classes[type] || 'bg-secondary';
        }

        getRiskPercentage(riskLevel) {
          switch (riskLevel) {
            case 'low':
              return 25;
            case 'medium':
              return 50;
            case 'high':
              return 75;
            case 'critical':
              return 100;
            default:
              return 25;
          }
        }

        formatDateTime(date) {
          return date.toLocaleString();
        }

        showLoadingState() {
          $('#loading-overlay').show();
        }

        hideLoadingState() {
          $('#loading-overlay').hide();
        }

        showError(message) {
          const alert = $(`<div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle mr-2"></i>${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>`);

          $('.container-fluid').prepend(alert);
          setTimeout(() => alert.alert('close'), 5000);
        }

        showSuccess(message) {
          const alert = $(`<div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle mr-2"></i>${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>`);

          $('.container-fluid').prepend(alert);
          setTimeout(() => alert.alert('close'), 3000);
        }

        startRealTimeUpdates() {
          // Update data every 60 seconds
          setInterval(() => {
            if (document.visibilityState === 'visible') {
              this.loadSettlementData();
            }
          }, 60000);
        }
      }

      // Initialize the dashboard when the page loads
      $(document).ready(() => {
        window.collectionsDashboard = new CollectionsDashboard();
      });
    </script>
  </body>
</html>
