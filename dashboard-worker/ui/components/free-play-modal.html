<!-- Free Play Transactions Modal -->
<div id="free-play-modal" class="modal-overlay" style="display: none">
  <div class="modal-container large-modal">
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="fas fa-gift"></i>
        Free Play & Bonus Transaction Management
      </h3>
      <button type="button" class="modal-close" onclick="closeFreePlayModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Overview Dashboard -->
      <div class="free-play-section">
        <h4 class="section-title">
          <i class="fas fa-chart-line"></i>
          Free Play Overview
        </h4>

        <div class="overview-metrics">
          <div class="metric-card primary">
            <div class="metric-icon">
              <i class="fas fa-hand-holding-usd"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="total-issued">$0.00</div>
              <div class="metric-label">Total Issued</div>
            </div>
          </div>

          <div class="metric-card success">
            <div class="metric-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="total-redeemed">$0.00</div>
              <div class="metric-label">Total Redeemed</div>
            </div>
          </div>

          <div class="metric-card warning">
            <div class="metric-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="remaining-balance">$0.00</div>
              <div class="metric-label">Available Balance</div>
            </div>
          </div>

          <div class="metric-card info">
            <div class="metric-icon">
              <i class="fas fa-percentage"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value" id="redemption-rate">0.0%</div>
              <div class="metric-label">Redemption Rate</div>
            </div>
          </div>
        </div>

        <!-- Bonus Breakdown -->
        <div class="bonus-breakdown">
          <h5>Bonus Type Distribution</h5>
          <div class="breakdown-chart" id="bonus-breakdown-chart">
            <div class="chart-placeholder">
              <i class="fas fa-chart-pie"></i>
              <p>Loading bonus breakdown...</p>
            </div>
          </div>

          <div class="breakdown-legend" id="bonus-breakdown-legend">
            <!-- Legend items will be populated here -->
          </div>
        </div>
      </div>

      <!-- Customer Free Play Lookup -->
      <div class="free-play-section">
        <h4 class="section-title">
          <i class="fas fa-search"></i>
          Customer Free Play Lookup
        </h4>

        <div class="customer-lookup">
          <div class="lookup-form">
            <div class="form-group">
              <label for="fp-lookup-customer-id">Customer ID:</label>
              <input
                type="text"
                id="fp-lookup-customer-id"
                placeholder="Enter customer ID..."
                onkeypress="handleFpLookupKeyPress(event)"
              />
            </div>
            <button class="btn btn-primary" onclick="lookupCustomerFreePlay()">
              <i class="fas fa-search"></i>
              Lookup
            </button>
          </div>

          <div class="customer-free-play-display" id="customer-free-play-display" style="display: none">
            <div class="fp-customer-header">
              <h5 id="fp-customer-name">Customer Name</h5>
              <span class="fp-customer-id" id="fp-customer-id-display">CUST_001</span>
            </div>

            <div class="fp-customer-stats">
              <div class="fp-stat-item">
                <span class="fp-stat-label">Total Free Play:</span>
                <span class="fp-stat-value" id="fp-total-free-play">$0.00</span>
              </div>
              <div class="fp-stat-item">
                <span class="fp-stat-label">Available:</span>
                <span class="fp-stat-value available" id="fp-available-free-play">$0.00</span>
              </div>
              <div class="fp-stat-item">
                <span class="fp-stat-label">Redeemed:</span>
                <span class="fp-stat-value redeemed" id="fp-redeemed-free-play">$0.00</span>
              </div>
              <div class="fp-stat-item">
                <span class="fp-stat-label">Expired:</span>
                <span class="fp-stat-value expired" id="fp-expired-free-play">$0.00</span>
              </div>
            </div>

            <div class="fp-customer-actions">
              <button class="btn btn-sm btn-success" onclick="createFreePlayForCustomer()">
                <i class="fas fa-plus"></i>
                Add Bonus
              </button>
              <button class="btn btn-sm btn-primary" onclick="viewCustomerFreePlayHistory()">
                <i class="fas fa-history"></i>
                View History
              </button>
              <button class="btn btn-sm btn-warning" onclick="adjustCustomerFreePlay()">
                <i class="fas fa-sliders-h"></i>
                Adjust Balance
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Free Play Transactions History -->
      <div class="free-play-section">
        <h4 class="section-title">
          <i class="fas fa-history"></i>
          Free Play Transaction History
        </h4>

        <!-- History Filters -->
        <div class="history-filters">
          <div class="filter-row">
            <div class="filter-group">
              <label for="fp-history-customer">Customer:</label>
              <select id="fp-history-customer" onchange="filterFreePlayHistory()">
                <option value="">All Customers</option>
                <!-- Customers will be populated dynamically -->
              </select>
            </div>

            <div class="filter-group">
              <label for="fp-history-type">Bonus Type:</label>
              <select id="fp-history-type" onchange="filterFreePlayHistory()">
                <option value="all">All Types</option>
                <option value="welcome_bonus">Welcome Bonus</option>
                <option value="deposit_match">Deposit Match</option>
                <option value="free_bet">Free Bet</option>
                <option value="loyalty">Loyalty Reward</option>
                <option value="referral">Referral Bonus</option>
                <option value="tournament">Tournament Prize</option>
                <option value="promotion">Special Promotion</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="fp-history-status">Status:</label>
              <select id="fp-history-status" onchange="filterFreePlayHistory()">
                <option value="all">All Status</option>
                <option value="available">Available</option>
                <option value="redeemed">Redeemed</option>
                <option value="expired">Expired</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>

            <div class="filter-group">
              <label for="fp-history-from-date">From Date:</label>
              <input type="date" id="fp-history-from-date" onchange="filterFreePlayHistory()" />
            </div>

            <div class="filter-group">
              <label for="fp-history-to-date">To Date:</label>
              <input type="date" id="fp-history-to-date" onchange="filterFreePlayHistory()" />
            </div>

            <button class="btn btn-sm btn-secondary" onclick="clearFpHistoryFilters()">Clear Filters</button>
          </div>
        </div>

        <!-- History Table -->
        <div class="history-table-container">
          <table class="history-table" id="free-play-history-table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Bonus Type</th>
                <th>Amount</th>
                <th>Wagering Req.</th>
                <th>Progress</th>
                <th>Status</th>
                <th>Expires</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="free-play-history-body">
              <!-- History entries will be populated here -->
            </tbody>
          </table>

          <div class="loading-spinner" id="fp-history-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Loading free play history...</span>
          </div>

          <div class="empty-state" id="fp-history-empty" style="display: none">
            <i class="fas fa-history"></i>
            <p>No free play transactions found</p>
          </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="free-play-pagination" style="display: none">
          <button
            class="btn btn-sm"
            id="fp-history-prev-page"
            onclick="loadFreePlayHistoryPage(currentFreePlayPage - 1)"
          >
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <span id="fp-history-page-info">Page 1 of 1</span>
          <button
            class="btn btn-sm"
            id="fp-history-next-page"
            onclick="loadFreePlayHistoryPage(currentFreePlayPage + 1)"
          >
            Next
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="free-play-section">
        <h4 class="section-title">
          <i class="fas fa-bolt"></i>
          Quick Actions
        </h4>

        <div class="quick-actions-grid">
          <button class="btn btn-success" onclick="showCreateBonusModal()">
            <i class="fas fa-plus-circle"></i>
            Create Bonus
          </button>
          <button class="btn btn-primary" onclick="showBulkBonusModal()">
            <i class="fas fa-layer-group"></i>
            Bulk Bonuses
          </button>
          <button class="btn btn-info" onclick="showRedeemBonusModal()">
            <i class="fas fa-gift"></i>
            Redeem Bonus
          </button>
          <button class="btn btn-warning" onclick="generateBonusReport()">
            <i class="fas fa-file-invoice-dollar"></i>
            Generate Report
          </button>
          <button class="btn btn-secondary" onclick="showBonusAnalytics()">
            <i class="fas fa-chart-bar"></i>
            Analytics
          </button>
          <button class="btn btn-danger" onclick="showBonusSettings()">
            <i class="fas fa-cog"></i>
            Settings
          </button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <div class="free-play-info">
        <span id="last-free-play-update">Last updated: Loading...</span>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeFreePlayModal()">
          <i class="fas fa-times"></i>
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Create Bonus Modal -->
<div id="create-bonus-modal" class="modal-overlay" style="display: none">
  <div class="modal-container medium-modal">
    <div class="modal-header">
      <h4 class="modal-title">
        <i class="fas fa-plus-circle"></i>
        Create Free Play Bonus
      </h4>
    </div>

    <div class="modal-body">
      <form id="create-bonus-form">
        <div class="form-group">
          <label for="bonus-customer-id">Customer ID:</label>
          <input type="text" id="bonus-customer-id" required placeholder="CUST_001" />
        </div>

        <div class="form-group">
          <label for="bonus-type">Bonus Type:</label>
          <select id="bonus-type" required>
            <option value="">Select Type</option>
            <option value="welcome_bonus">Welcome Bonus</option>
            <option value="deposit_match">Deposit Match</option>
            <option value="free_bet">Free Bet</option>
            <option value="loyalty">Loyalty Reward</option>
            <option value="referral">Referral Bonus</option>
            <option value="tournament">Tournament Prize</option>
            <option value="promotion">Special Promotion</option>
          </select>
        </div>

        <div class="form-group">
          <label for="bonus-amount">Bonus Amount:</label>
          <input type="number" id="bonus-amount" step="0.01" min="0" required />
        </div>

        <div class="form-group">
          <label for="wagering-requirement">Wagering Requirement:</label>
          <input type="number" id="wagering-requirement" step="0.1" min="1" max="50" required placeholder="10" />
        </div>

        <div class="form-group">
          <label for="bonus-expires-in">Expires In (Days):</label>
          <input type="number" id="bonus-expires-in" min="1" max="90" required placeholder="30" />
        </div>

        <div class="form-group">
          <label for="bonus-description">Description:</label>
          <input type="text" id="bonus-description" required placeholder="Bonus description" />
        </div>

        <div class="form-group">
          <label for="bonus-reference">Reference:</label>
          <input type="text" id="bonus-reference" placeholder="Bonus reference" />
        </div>

        <div class="form-group">
          <label for="bonus-notes">Notes:</label>
          <textarea id="bonus-notes" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label for="bonus-processed-by">Processed By:</label>
          <input type="text" id="bonus-processed-by" value="Current User" required />
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeCreateBonusModal()">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="createBonus()">
          <i class="fas fa-save"></i>
          Create Bonus
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Redeem Bonus Modal -->
<div id="redeem-bonus-modal" class="modal-overlay" style="display: none">
  <div class="modal-container medium-modal">
    <div class="modal-header">
      <h4 class="modal-title">
        <i class="fas fa-gift"></i>
        Redeem Free Play Bonus
      </h4>
    </div>

    <div class="modal-body">
      <form id="redeem-bonus-form">
        <div class="form-group">
          <label for="redeem-transaction-id">Transaction ID:</label>
          <input type="text" id="redeem-transaction-id" required placeholder="FP_123456789" />
        </div>

        <div class="form-group">
          <label for="redeem-customer-id">Customer ID:</label>
          <input type="text" id="redeem-customer-id" required placeholder="CUST_001" />
        </div>

        <div class="form-group">
          <label for="redeem-amount">Redemption Amount:</label>
          <input type="number" id="redeem-amount" step="0.01" min="0" required />
        </div>

        <div class="form-group">
          <label for="redeem-wager-amount">Wager Amount (if applicable):</label>
          <input type="number" id="redeem-wager-amount" step="0.01" min="0" />
        </div>

        <div class="form-group">
          <label for="redeem-processed-by">Processed By:</label>
          <input type="text" id="redeem-processed-by" value="Current User" required />
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeRedeemBonusModal()">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="redeemBonus()">
          <i class="fas fa-check"></i>
          Redeem Bonus
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Styles -->
<style>
  .large-modal .modal-container {
    max-width: 1400px;
    width: 95%;
  }

  .medium-modal .modal-container {
    max-width: 800px;
    width: 90%;
  }

  .overview-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .metric-card {
    display: flex;
    align-items: center;
    padding: 20px;
    background: var(--surface-secondary, #f8f9fa);
    border-radius: 12px;
    border: 2px solid var(--border-color, #e0e0e0);
    transition: all 0.3s ease;
  }

  .metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .metric-card.primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
  }

  .metric-card.success {
    background: linear-gradient(135deg, #11998e, #38ef7d);
    color: white;
  }

  .metric-card.warning {
    background: linear-gradient(135deg, #fcb045, #fd1d1d);
    color: white;
  }

  .metric-card.info {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
  }

  .metric-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 16px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-size: 1.2rem;
  }

  .metric-content {
    flex: 1;
  }

  .metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 4px;
  }

  .metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
  }

  .bonus-breakdown {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
    padding: 20px;
    background: var(--surface-secondary, #f8f9fa);
    border-radius: 8px;
  }

  .bonus-breakdown h5 {
    margin: 0 0 16px 0;
    grid-column: 1 / -1;
    color: var(--text-color, #333333);
  }

  .breakdown-chart {
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: 8px;
    border: 2px dashed var(--border-color, #e0e0e0);
  }

  .chart-placeholder {
    text-align: center;
    color: var(--text-muted, #666666);
  }

  .chart-placeholder i {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  .breakdown-legend {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .legend-color {
    width: 16px;
    height: 16px;
    border-radius: 2px;
  }

  .legend-label {
    flex: 1;
    font-size: 0.9rem;
  }

  .legend-value {
    font-weight: bold;
    color: var(--text-color, #333333);
  }

  .customer-lookup {
    margin-bottom: 24px;
  }

  .lookup-form {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    align-items: end;
  }

  .lookup-form .form-group {
    flex: 1;
    margin-bottom: 0;
  }

  .customer-free-play-display {
    background: var(--surface-secondary, #f8f9fa);
    padding: 20px;
    border-radius: 12px;
    border: 2px solid var(--border-color, #e0e0e0);
  }

  .fp-customer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .fp-customer-header h5 {
    margin: 0;
    color: var(--text-color, #333333);
  }

  .fp-customer-id {
    background: var(--primary-color, #007bff);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .fp-customer-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
  }

  .fp-stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
  }

  .fp-stat-item:last-child {
    border-bottom: none;
  }

  .fp-stat-label {
    font-weight: 500;
    color: var(--text-color, #333333);
  }

  .fp-stat-value {
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--success-color, #28a745);
  }

  .fp-stat-value.available {
    color: var(--info-color, #17a2b8);
  }

  .fp-stat-value.redeemed {
    color: var(--success-color, #28a745);
  }

  .fp-stat-value.expired {
    color: var(--danger-color, #dc3545);
  }

  .fp-customer-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .history-filters {
    margin-bottom: 20px;
  }

  .filter-row {
    display: flex;
    gap: 16px;
    padding: 16px;
    background: var(--surface-secondary, #f8f9fa);
    border-radius: 8px;
    border: 1px solid var(--border-color, #e0e0e0);
    flex-wrap: wrap;
  }

  .filter-row .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 120px;
  }

  .filter-row label {
    font-weight: 500;
    font-size: 0.9rem;
    color: var(--text-color, #333333);
  }

  .filter-row select,
  .filter-row input {
    padding: 8px 12px;
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 4px;
    background: white;
    font-size: 0.9rem;
  }

  .history-table-container {
    overflow-x: auto;
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 8px;
    background: white;
    margin-bottom: 16px;
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
  }

  .history-table th,
  .history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
  }

  .history-table th {
    background: var(--surface-secondary, #f8f9fa);
    font-weight: 600;
    color: var(--text-color, #333333);
  }

  .history-table tbody tr:hover {
    background: var(--surface-secondary, #f8f9fa);
  }

  .bonus-type-badge,
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
  }

  .bonus-type-welcome_bonus {
    background: rgba(52, 152, 219, 0.1);
    color: #3498db;
  }

  .bonus-type-deposit_match {
    background: rgba(46, 204, 113, 0.1);
    color: #2ecc71;
  }

  .bonus-type-free_bet {
    background: rgba(155, 89, 182, 0.1);
    color: #9b59b6;
  }

  .bonus-type-loyalty {
    background: rgba(230, 126, 34, 0.1);
    color: #e67e22;
  }

  .status-available {
    background: rgba(25, 135, 84, 0.1);
    color: var(--success-color, #198754);
  }

  .status-redeemed {
    background: rgba(0, 123, 255, 0.1);
    color: var(--primary-color, #007bff);
  }

  .status-expired {
    background: rgba(220, 53, 69, 0.1);
    color: var(--danger-color, #dc3545);
  }

  .status-cancelled {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
  }

  .wagering-progress {
    position: relative;
    width: 100px;
    height: 8px;
    background: var(--border-color, #e0e0e0);
    border-radius: 4px;
    overflow: hidden;
  }

  .wagering-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    border-radius: 4px;
    transition: width 0.3s ease;
  }

  .fp-actions {
    display: flex;
    gap: 4px;
  }

  .btn-sm {
    padding: 4px 8px;
    font-size: 0.8rem;
    border-radius: 4px;
  }

  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--text-muted, #666666);
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .large-modal .modal-container {
      width: 98%;
      margin: 10px;
    }

    .overview-metrics {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .bonus-breakdown {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .lookup-form {
      flex-direction: column;
      gap: 12px;
    }

    .lookup-form .form-group {
      margin-bottom: 0;
    }

    .filter-row {
      flex-direction: column;
      gap: 12px;
    }

    .filter-row .filter-group {
      flex-direction: row;
      align-items: center;
      gap: 12px;
    }

    .filter-row label {
      min-width: 80px;
      margin-bottom: 0;
    }

    .fp-customer-stats {
      grid-template-columns: 1fr;
    }

    .fp-customer-actions {
      flex-direction: column;
    }

    .fp-customer-actions .btn {
      width: 100%;
      margin-bottom: 4px;
    }

    .quick-actions-grid {
      grid-template-columns: 1fr;
    }

    .fp-actions {
      flex-direction: column;
    }

    .fp-actions .btn {
      width: 100%;
      margin-bottom: 4px;
    }

    .history-table {
      font-size: 0.9rem;
    }

    .history-table th,
    .history-table td {
      padding: 8px;
    }
  }

  @media (max-width: 480px) {
    .overview-metrics {
      grid-template-columns: 1fr;
    }

    .metric-card {
      padding: 16px;
    }

    .metric-icon {
      width: 40px;
      height: 40px;
      font-size: 1rem;
    }

    .metric-value {
      font-size: 1.5rem;
    }

    .modal-container {
      margin: 10px;
      width: calc(100vw - 20px);
    }
  }
</style>

<!-- Free Play Modal JavaScript -->
<script>
  // Global variables for free play
  let currentFreePlayPage = 1;
  let freePlayOverview = null;
  let currentFreePlayCustomers = [];

  // Free Play Modal Functions
  function openFreePlayModal() {
    const modal = document.getElementById('free-play-modal');
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';

      // Load initial data
      loadFreePlayOverview();
      loadFreePlayHistory();
    }
  }

  function closeFreePlayModal() {
    const modal = document.getElementById('free-play-modal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
  }

  function closeCreateBonusModal() {
    const modal = document.getElementById('create-bonus-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  function closeRedeemBonusModal() {
    const modal = document.getElementById('redeem-bonus-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  async function loadFreePlayOverview() {
    try {
      const response = await fetch('/api/other/free-play/overview?includeDetails=true', {
        method: 'GET',
        headers: {
          Authorization: `Bearer ${getAuthToken()}`,
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();

      if (data.success && data.data) {
        freePlayOverview = data.data;
        updateFreePlayOverview(data.data);
        updateLastFreePlayUpdate();
      }
    } catch (error) {
      console.error('Error loading free play overview:', error);
      showError('Failed to load free play overview');
    }
  }

  function updateFreePlayOverview(overview) {
    document.getElementById('total-issued').textContent = `$${overview.totalFreePlayIssued.toFixed(2)}`;
    document.getElementById('total-redeemed').textContent = `$${overview.totalFreePlayRedeemed.toFixed(2)}`;
    document.getElementById('remaining-balance').textContent = `$${overview.remainingFreePlay.toFixed(2)}`;
    document.getElementById('redemption-rate').textContent = `${overview.redemptionRate}%`;

    // Update breakdown chart if details are available
    if (overview.breakdown) {
      updateBonusBreakdownChart(overview.breakdown);
    }
  }

  function updateBonusBreakdownChart(breakdown) {
    const legendContainer = document.getElementById('bonus-breakdown-legend');

    const legendItems = [
      { label: 'Welcome Bonuses', value: breakdown.welcomeBonuses, color: '#3498db' },
      { label: 'Deposit Match Bonuses', value: breakdown.depositMatchBonuses, color: '#2ecc71' },
      { label: 'Free Bets', value: breakdown.freeBets, color: '#9b59b6' },
      { label: 'Loyalty Rewards', value: breakdown.loyaltyRewards, color: '#e67e22' },
      { label: 'Referral Bonuses', value: breakdown.referralBonuses, color: '#f39c12' },
      { label: 'Tournament Prizes', value: breakdown.tournamentPrizes, color: '#e74c3c' },
      { label: 'Special Promotions', value: breakdown.specialPromotions, color: '#95a5a6' },
    ];

    legendContainer.innerHTML = legendItems
      .filter(item => item.value > 0)
      .map(
        item => `
      <div class="legend-item">
        <div class="legend-color" style="background-color: ${item.color};"></div>
        <div class="legend-label">${item.label}</div>
        <div class="legend-value">$${item.value.toFixed(2)}</div>
      </div>
    `
      )
      .join('');
  }

  function handleFpLookupKeyPress(event) {
    if (event.key === 'Enter') {
      lookupCustomerFreePlay();
    }
  }

  async function lookupCustomerFreePlay() {
    const customerId = document.getElementById('fp-lookup-customer-id').value.trim();

    if (!customerId) {
      showError('Please enter a customer ID');
      return;
    }

    try {
      // For now, we'll use mock data since the API doesn't have a specific customer lookup endpoint
      // In a real implementation, you'd call an API endpoint to get customer free play data
      const mockCustomerData = {
        CUST_001: {
          customerId: 'CUST_001',
          customerName: 'John Doe',
          totalFreePlay: 2500.0,
          redeemedFreePlay: 1800.0,
          availableFreePlay: 700.0,
          expiredFreePlay: 0.0,
        },
        CUST_002: {
          customerId: 'CUST_002',
          customerName: 'Jane Smith',
          totalFreePlay: 1250.0,
          redeemedFreePlay: 950.0,
          availableFreePlay: 300.0,
          expiredFreePlay: 0.0,
        },
      };

      const customerData = mockCustomerData[customerId];

      if (!customerData) {
        showError('Customer not found or has no free play transactions');
        return;
      }

      displayCustomerFreePlay(customerData);
    } catch (error) {
      console.error('Error looking up customer free play:', error);
      showError('Failed to lookup customer free play');
    }
  }

  function displayCustomerFreePlay(customerData) {
    document.getElementById('fp-customer-name').textContent = customerData.customerName;
    document.getElementById('fp-customer-id-display').textContent = customerData.customerId;
    document.getElementById('fp-total-free-play').textContent = `$${customerData.totalFreePlay.toFixed(2)}`;
    document.getElementById('fp-available-free-play').textContent = `$${customerData.availableFreePlay.toFixed(2)}`;
    document.getElementById('fp-redeemed-free-play').textContent = `$${customerData.redeemedFreePlay.toFixed(2)}`;
    document.getElementById('fp-expired-free-play').textContent = `$${customerData.expiredFreePlay.toFixed(2)}`;

    document.getElementById('customer-free-play-display').style.display = 'block';

    // Store customer data for other operations
    window.currentFreePlayCustomer = customerData;
  }

  async function loadFreePlayHistory(page = 1) {
    const historyTableBody = document.getElementById('free-play-history-body');
    const loadingSpinner = document.getElementById('fp-history-loading');
    const emptyState = document.getElementById('fp-history-empty');
    const pagination = document.getElementById('free-play-pagination');

    // Show loading
    loadingSpinner.style.display = 'block';
    historyTableBody.style.display = 'none';
    emptyState.style.display = 'none';
    pagination.style.display = 'none';

    try {
      const customer = document.getElementById('fp-history-customer').value;
      const type = document.getElementById('fp-history-type').value;
      const status = document.getElementById('fp-history-status').value;
      const fromDate = document.getElementById('fp-history-from-date').value;
      const toDate = document.getElementById('fp-history-to-date').value;

      const params = new URLSearchParams();
      params.append('page', page.toString());
      params.append('limit', '20');

      if (customer) params.append('customerId', customer);
      if (type !== 'all') params.append('type', type);
      if (status !== 'all') params.append('status', status);
      if (fromDate) params.append('dateFrom', fromDate);
      if (toDate) params.append('dateTo', toDate);

      const response = await fetch(`/api/other/free-play/history?${params}`, {
        method: 'GET',
        headers: {
          Authorization: `Bearer ${getAuthToken()}`,
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();

      if (data.success && data.data) {
        currentFreePlayPage = page;
        displayFreePlayHistory(data.data.transactions);
        updateFreePlayPagination(data.data.pagination);
        populateCustomerFilter(data.data.transactions);

        // Hide loading, show table
        loadingSpinner.style.display = 'none';
        historyTableBody.style.display = '';
        pagination.style.display = data.data.pagination.totalPages > 1 ? '' : 'none';
      } else {
        showFreePlayHistoryEmpty();
      }
    } catch (error) {
      console.error('Error loading free play history:', error);
      loadingSpinner.style.display = 'none';
      historyTableBody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; color: var(--danger-color, #dc3545);">
          <i class="fas fa-exclamation-triangle"></i>
          Failed to load free play history: ${error.message}
        </td>
      </tr>
    `;
      historyTableBody.style.display = '';
    }
  }

  function displayFreePlayHistory(history) {
    const tableBody = document.getElementById('free-play-history-body');

    if (!history || history.length === 0) {
      showFreePlayHistoryEmpty();
      return;
    }

    tableBody.innerHTML = history
      .map(item => {
        const progressPercent =
          item.wageringRequirement > 0 ? (item.wageringCompleted / item.wageringRequirement) * 100 : 100;
        const progressColor = progressPercent >= 100 ? '#28a745' : progressPercent >= 50 ? '#ffc107' : '#dc3545';

        return `
      <tr>
        <td>
          <div class="customer-name">${item.customerName}</div>
          <div class="customer-id">${item.customerId}</div>
        </td>
        <td>
          <span class="bonus-type-badge bonus-type-${item.type}">
            ${item.type.replace('_', ' ').toUpperCase()}
          </span>
        </td>
        <td class="amount-cell">$${item.amount.toFixed(2)}</td>
        <td>${item.wageringRequirement}x</td>
        <td>
          <div class="wagering-progress">
            <div class="wagering-fill" style="width: ${Math.min(progressPercent, 100)}%; background: ${progressColor};"></div>
          </div>
          <small>${item.wageringCompleted.toFixed(1)}/${item.wageringRequirement.toFixed(1)}</small>
        </td>
        <td>
          <span class="status-badge status-${item.status}">
            ${item.status}
          </span>
        </td>
        <td>${new Date(item.expiresAt).toLocaleDateString()}</td>
        <td>
          <div class="fp-actions">
            <button class="btn btn-sm btn-info" onclick="viewFreePlayTransaction('${item.id}')">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-primary" onclick="editFreePlayTransaction('${item.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-success" onclick="redeemFreePlayTransaction('${item.id}')">
              <i class="fas fa-gift"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
      })
      .join('');
  }

  function showFreePlayHistoryEmpty() {
    const tableBody = document.getElementById('free-play-history-body');
    const loadingSpinner = document.getElementById('fp-history-loading');
    const emptyState = document.getElementById('fp-history-empty');

    loadingSpinner.style.display = 'none';
    tableBody.style.display = 'none';
    emptyState.style.display = 'flex';
  }

  function updateFreePlayPagination(pagination) {
    const paginationDiv = document.getElementById('free-play-pagination');
    const pageInfo = document.getElementById('fp-history-page-info');
    const prevBtn = document.getElementById('fp-history-prev-page');
    const nextBtn = document.getElementById('fp-history-next-page');

    pageInfo.textContent = `Page ${pagination.page} of ${pagination.totalPages}`;
    prevBtn.disabled = !pagination.hasPrevPage;
    nextBtn.disabled = !pagination.hasNextPage;
  }

  function populateCustomerFilter(history) {
    const customerSelect = document.getElementById('fp-history-customer');

    // Get unique customers from history
    const customers = [...new Set(history.map(h => ({ id: h.customerId, name: h.customerName })))];

    const customerOptions = customers
      .map(customer => `<option value="${customer.id}">${customer.name}</option>`)
      .join('');

    customerSelect.innerHTML = '<option value="">All Customers</option>' + customerOptions;
  }

  function loadFreePlayHistoryPage(page) {
    loadFreePlayHistory(page);
  }

  function filterFreePlayHistory() {
    loadFreePlayHistory(1);
  }

  function clearFpHistoryFilters() {
    document.getElementById('fp-history-customer').value = '';
    document.getElementById('fp-history-type').value = 'all';
    document.getElementById('fp-history-status').value = 'all';
    document.getElementById('fp-history-from-date').value = '';
    document.getElementById('fp-history-to-date').value = '';
    loadFreePlayHistory(1);
  }

  function updateLastFreePlayUpdate() {
    const now = new Date();
    document.getElementById('last-free-play-update').textContent = `Last updated: ${now.toLocaleString()}`;
  }

  function showCreateBonusModal() {
    document.getElementById('create-bonus-modal').style.display = 'flex';
  }

  function createFreePlayForCustomer() {
    if (window.currentFreePlayCustomer) {
      document.getElementById('bonus-customer-id').value = window.currentFreePlayCustomer.customerId;
    }
    showCreateBonusModal();
  }

  function createBonus() {
    // Implementation for creating bonus
    showError('Create bonus functionality coming soon');
  }

  function showRedeemBonusModal() {
    document.getElementById('redeem-bonus-modal').style.display = 'flex';
  }

  function redeemFreePlayTransaction(transactionId) {
    document.getElementById('redeem-transaction-id').value = transactionId;
    if (window.currentFreePlayCustomer) {
      document.getElementById('redeem-customer-id').value = window.currentFreePlayCustomer.customerId;
    }
    showRedeemBonusModal();
  }

  function redeemBonus() {
    // Implementation for redeeming bonus
    showError('Redeem bonus functionality coming soon');
  }

  function viewFreePlayTransaction(transactionId) {
    // Implementation for viewing transaction details
    showError('View transaction functionality coming soon');
  }

  function editFreePlayTransaction(transactionId) {
    // Implementation for editing transaction
    showError('Edit transaction functionality coming soon');
  }

  function viewCustomerFreePlayHistory() {
    if (window.currentFreePlayCustomer) {
      document.getElementById('fp-history-customer').value = window.currentFreePlayCustomer.customerId;
      filterFreePlayHistory();
    }
  }

  function adjustCustomerFreePlay() {
    // Implementation for adjusting customer free play
    showError('Adjust free play functionality coming soon');
  }

  function showBulkBonusModal() {
    // Implementation for bulk bonuses
    showError('Bulk bonus functionality coming soon');
  }

  function generateBonusReport() {
    // Implementation for generating reports
    showError('Generate report functionality coming soon');
  }

  function showBonusAnalytics() {
    // Implementation for showing analytics
    showError('Analytics functionality coming soon');
  }

  function showBonusSettings() {
    // Implementation for showing settings
    showError('Settings functionality coming soon');
  }

  // Helper functions
  function getAuthToken() {
    return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
  }

  function showSuccess(message) {
    console.log('✅ Success:', message);
    // Implement your success notification system
    alert('Success: ' + message);
  }

  function showError(message) {
    console.error('❌ Error:', message);
    // Implement your error notification system
    alert('Error: ' + message);
  }

  // Export functions for global access
  window.openFreePlayModal = openFreePlayModal;
  window.closeFreePlayModal = closeFreePlayModal;
  window.closeCreateBonusModal = closeCreateBonusModal;
  window.closeRedeemBonusModal = closeRedeemBonusModal;
  window.loadFreePlayHistory = loadFreePlayHistory;
</script>
