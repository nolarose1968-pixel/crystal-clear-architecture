name: ğŸš€ Deploy Docs Worker

on:
  push:
    branches: [main]
    paths:
      - "docs/**"
      - "docs-worker/**"
      - ".github/workflows/deploy-docs-worker.yml"
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Documentation CDN

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: docs-worker/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./docs-worker
        run: npm ci

      - name: ğŸ” Type check
        working-directory: ./docs-worker
        run: npm run typecheck

      - name: ğŸ“ Lint code
        working-directory: ./docs-worker
        run: npm run lint || true

      - name: ğŸš€ Deploy to Cloudflare
        working-directory: ./docs-worker
        run: |
          echo "Deploying Crystal Clear Docs Worker..."
          npm run deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ“Š Update deployment status
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const deploymentUrl = 'https://crystal-clear-docs.nolarose1968.workers.dev';

            // Create deployment status
            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: context.payload.deployment?.id || 1,
              state: 'success',
              environment_url: deploymentUrl,
              description: 'Documentation CDN deployed successfully'
            });

            // Add comment to PR if this is from a PR
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.payload.pull_request.number,
                body: `ğŸš€ **Documentation CDN Deployed Successfully!**

                ğŸ“– **Live Documentation**: ${deploymentUrl}
                ğŸ—ï¸ **Build Status**: âœ… Success
                â±ï¸ **Deployed**: ${new Date().toISOString()}

                The documentation has been automatically deployed to Cloudflare Workers and is now live at the URL above.`
              });
            }

      - name: âŒ Report deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;

            // Create deployment status for failure
            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: context.payload.deployment?.id || 1,
              state: 'failure',
              description: 'Documentation CDN deployment failed'
            });

            // Add comment to PR if this is from a PR
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.payload.pull_request.number,
                body: `âŒ **Documentation CDN Deployment Failed**

                ğŸ—ï¸ **Build Status**: âŒ Failed
                â±ï¸ **Timestamp**: ${new Date().toISOString()}

                Please check the deployment logs above for details on what went wrong.`
              });
            }

  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    name: Health Check

    steps:
      - name: ğŸ©º Verify deployment health
        run: |
          echo "ğŸ” Checking deployment health..."
          for i in {1..10}; do
            if curl -s -f https://crystal-clear-docs.nolarose1968.workers.dev/api/health > /dev/null; then
              echo "âœ… Documentation CDN is healthy!"
              curl -s https://crystal-clear-docs.nolarose1968.workers.dev/api/health | jq .
              break
            else
              echo "â³ Waiting for deployment... (attempt $i/10)"
              sleep 30
            fi
          done

          # Final check
          if curl -s -f https://crystal-clear-docs.nolarose1968.workers.dev/api/health > /dev/null; then
            echo "ğŸ‰ Deployment successful and healthy!"
          else
            echo "âŒ Deployment failed health check"
            exit 1
          fi

  notify:
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: success()
    name: Notification

    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          echo "ğŸš€ Crystal Clear Documentation CDN Deployed Successfully!"
          echo ""
          echo "ğŸ“– Live URL: https://crystal-clear-docs.nolarose1968.workers.dev"
          echo "ğŸ“Š Health Check: https://crystal-clear-docs.nolarose1968.workers.dev/api/health"
          echo "ğŸ“‹ API Info: https://crystal-clear-docs.nolarose1968.workers.dev/api/docs"
          echo ""
          echo "ğŸ”§ Features:"
          echo "  â€¢ Automatic content fetching from GitHub"
          echo "  â€¢ Smart caching with ETags"
          echo "  â€¢ Real-time updates on git push"
          echo "  â€¢ CDN optimization"
          echo "  â€¢ Comprehensive health monitoring"
